# Especificación de Caso de Uso — CU-004-004

## Encabezado del formulario
- **Código:** CU-004-004
- **Nombre:** Secuencia extremo a extremo de scoring
- **Referencias:** `PDFViewerAIService.CalculateSuspicionScoreAsync`, `AISecurityService.AnalyzeUserBehaviorAsync`, diagramas CORE 1 en `docs/AI_scoring.md`
- **Autor:** (completar)
- **Revisor:** (completar)
- **Fecha:** (completar)
- **Estado:** Borrador

## Detalle del caso de uso
- **Descripción:** El sistema orquesta el scoring de una sesión del visor PDF de punta a punta: recibe la telemetría de la UI, calcula el `SuspicionScore` con señales de sesión, integra riesgo histórico y reputación/IP, y devuelve score + recomendaciones mientras registra alertas y evidencias.
- **Actores:** Usuario (primario), Analista de seguridad (secundario), Motor de Scoring (secundario), Servicio de comportamiento (`AISecurityService`) (soporte).
- **Pre-condición:** Existe una sesión activa del visor PDF con telemetría disponible (eventos, timestamps, IP, identificador de usuario si aplica).
- **Post-condición:** Se genera y persiste un `SuspicionScore` con razones; si se superan umbrales, se crea alerta con contexto histórico e IP.
- **Condición:** Los factores de scoring se calculan de forma secuencial (eventos → riesgo histórico → reputación/IP) antes de normalizar el score.
- **Puntos de extensión:** Ajustes de umbrales/ponderaciones y acciones operativas posteriores (alerta, monitoreo, bloqueo).

## Curso básico
1. El usuario interactúa con el visor PDF; la UI recopila eventos de sesión y metadatos (IP, usuario, timestamps).
2. La UI envía la sesión al backend (`PDFViewerController`).
3. El backend delega en `PDFViewerAIService` el cálculo inicial del `SuspicionScore` con los eventos de sesión.
4. El servicio consulta a `AISecurityService.AnalyzeUserBehaviorAsync` para obtener `RiskScore` histórico y anomalías del usuario.
5. El scoring se ajusta con la contribución de riesgo histórico (CU-002-002) y bonificación por anomalías.
6. El servicio compara la IP actual con la última IP conocida y evalúa la tasa de acciones sospechosas por minuto (CU-003-003); aplica los pesos correspondientes.
7. El `SuspicionScore` se normaliza (0–1), se generan razones y, si aplica, se crea una alerta con severidad/umbrales.
8. El backend responde a la UI con el score final y recomendaciones; la UI puede mostrar el resultado o tomar acciones locales.

## Cursos alternativos
- **A1: Sesión sin identificador de usuario**
  1. Si no se recibe `ViewerUserId`, el sistema omite la integración de riesgo histórico y el cálculo de IP previa.
  2. Continúa con el scoring basado solo en eventos de sesión y tasa sospechosa; persiste las razones disponibles.
- **A2: Fallo al obtener perfil histórico**
  1. Si `AnalyzeUserBehaviorAsync` no responde o no devuelve perfil, se deja constancia en las razones y se prosigue con los factores de sesión e IP.
- **A3: Umbral de alerta superado**
  1. Si el score final supera el umbral configurado, se genera alerta con severidad acorde y se notifica al analista.

## Pos-condición
- El proceso extremo a extremo queda registrado: score final, razones (eventos, riesgo histórico, IP/tasa), y estado de alerta asociado, disponible para revisión y auditoría.
