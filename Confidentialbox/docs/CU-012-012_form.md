# Especificación de Caso de Uso — CU-012-012

## Encabezado del formulario
- **Código:** CU-012-012
- **Nombre:** Cálculo de threat score por archivo
- **Referencias:** `AISecurityService.AnalyzeFileAsync`, configuraciones en `AIScoringSettings` y diagramas CORE 2 en `docs/AI_scoring.md`
- **Autor:** (completar)
- **Revisor:** (completar)
- **Fecha:** (completar)
- **Estado:** Borrador

## Detalle del caso de uso
- **Descripción:** El sistema evalúa cada archivo compartido/subido, calculando un `ThreatScore` (0–1) que combina señales directas (extensión sospechosa, tamaño, horario/volumen fuera de patrón), probabilidades de malware y riesgo de exfiltración, antes de permitir su disponibilidad.
- **Actores:** Usuario que sube/ comparte (primario), Motor de Scoring de archivos (secundario), Servicio de reputación/malware (soporte).
- **Pre-condición:** El usuario tiene permisos para subir/compartir; el archivo y sus metadatos (nombre, extensión, tamaño, horario, origen) están disponibles para análisis.
- **Post-condición:** Se registra un `ThreatScore` con razones asociadas; según umbrales, se marca el archivo como sospechoso/alto riesgo y se generan alertas o recomendaciones.
- **Condición:** El cálculo procede solo si se reciben metadatos mínimos (extensión, tamaño, usuario) y el motor de reputación responde.
- **Puntos de extensión:** Integración con `RiskScore` del usuario (para acentuar riesgo de exfiltración) y políticas de cuarentena/bloqueo automático.

## Curso básico
1. El usuario inicia una subida o comparte un archivo a través de la UI.
2. La UI envía al backend los metadatos del archivo y el binario (o referencia) para análisis.
3. `AISecurityService.AnalyzeFileAsync` clasifica la extensión, tamaño y horario contra configuraciones (`AIScoringSettings`).
4. El servicio invoca análisis de malware/reputación y obtiene probabilidades de amenaza/exfiltración.
5. Se calcula el `ThreatScore` agregando pesos de señales directas y probabilidades, normalizando a 0–1.
6. El sistema guarda el score, razones y, si excede umbrales (`SuspiciousThreshold`, `HighRiskThreshold`), etiqueta el archivo como sospechoso o de alto riesgo.
7. El backend responde a la UI con el resultado y recomendaciones (p. ej., cuarentena, revisión manual, bloqueo).

## Cursos alternativos
- **A1: Extensión bloqueada por política**
  1. Si la extensión está en lista negra, se asigna el peso máximo al factor de extensión y se recomienda bloqueo inmediato.
- **A2: Probabilidad de malware alta**
  1. Si la probabilidad de malware supera el umbral de alto riesgo, el sistema eleva el `ThreatScore` al máximo y marca el archivo para cuarentena.
- **A3: Falta de datos de reputación**
  1. Si el servicio de reputación no responde, se documenta la limitación y el score se basa en señales directas; se sugiere revisión manual.

## Diagrama de secuencia (CU-012-012)
```plantuml
@startuml
title CU-012-012 - Secuencia de cálculo de threat score por archivo
actor Usuario
participant "UI de subida/compartir" as UI
participant "Security API" as API
participant "AISecurityService" as FileScoring
participant "Malware/Reputation Service" as Malware
database "ThreatScores" as Scores
database "AlertLog" as Alertas

Usuario -> UI : Subir/compartir archivo
UI -> API : Enviar metadatos y binario/ref
API -> FileScoring : Solicitar ThreatScore
FileScoring -> Malware : Consultar prob. malware/exfiltración
FileScoring -> FileScoring : Ponderar señales y normalizar
FileScoring -> Scores : Persistir score + razones
FileScoring -> Alertas : Crear alerta si aplica
FileScoring --> API : Score + recomendaciones
API --> UI : Responder al usuario
@enduml
```

## Diagrama de robustez (CU-012-012)
```plantuml
@startuml
title CU-012-012 - Cálculo de threat score por archivo
actor Usuario
boundary "UI de subida/compartir" as UI
boundary "Security API" as API
control "AISecurityService" as FileScoring
control "Malware/Reputation Service" as Malware
entity "Metadatos de archivo" as Metadata
entity "ThreatScores" as Scores
entity "AlertLog" as Alertas

Usuario -> UI : Selecciona y envía archivo
UI -> API : Mandar metadatos y binario/ref
API -> FileScoring : Calcular ThreatScore
FileScoring -> Metadata : Evaluar extensión/tamaño/horario
FileScoring -> Malware : Consultar prob. malware/exfiltración
FileScoring -> Scores : Guardar ThreatScore y razones
FileScoring -> Alertas : Crear alerta si supera umbral
API -> UI : Responder score y recomendaciones
@enduml
```

## Pos-condición
- El archivo queda registrado con su `ThreatScore`, razones y estado (permitido, sospechoso, alto riesgo/cuarentena), habilitando auditoría y decisiones operativas posteriores.
