@page "/settings"
@attribute [Authorize(Roles = "Admin")]
@using Microsoft.AspNetCore.Authorization
@using ConfidentialBox.Core.Configuration
@using ConfidentialBox.Core.DTOs
@inject ISettingsService SettingsService

<PageTitle>Configuración avanzada - ConfidentialBox</PageTitle>

<h1 class="mb-4"><i class="fas fa-cogs"></i> Configuración de la plataforma</h1>

@if (isLoading)
{
    <div class="text-center my-5">
        <div class="spinner-border" role="status"></div>
        <p class="mt-3">Cargando ajustes seguros...</p>
    </div>
}
else
{
    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Almacenamiento de archivos</h5>
                </div>
                <div class="card-body">
                    <EditForm Model="storageSettings" OnValidSubmit="UpdateStorageSettingsAsync">
                        <DataAnnotationsValidator />

                        @if (!string.IsNullOrEmpty(storageMessage))
                        {
                            <div class="alert @(storageSuccess ? "alert-success" : "alert-danger")">@storageMessage</div>
                        }

                        <div class="form-check form-switch mb-3">
                            <InputCheckbox @bind-Value="storageSettings.StoreInDatabase" class="form-check-input" id="dbStorage" />
                            <label class="form-check-label" for="dbStorage">Guardar en base de datos encriptada</label>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <InputCheckbox @bind-Value="storageSettings.StoreOnFileSystem" class="form-check-input" id="fsStorage" />
                            <label class="form-check-label" for="fsStorage">Guardar en almacenamiento seguro del servidor</label>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Directorio seguro</label>
                            <InputText @bind-Value="storageSettings.FileSystemDirectory" class="form-control" />
                            <div class="form-text">Ruta local o UNC con permisos restringidos. Siempre cifrado.</div>
                        </div>

                        <button class="btn btn-primary w-100" disabled="@storageSaving">
                            @if (storageSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2">Guardando...</span>
                            }
                            else
                            {
                                <span>Actualizar almacenamiento</span>
                            }
                        </button>
                    </EditForm>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Servidor de correo seguro</h5>
                </div>
                <div class="card-body">
                    <EditForm Model="emailServer" OnValidSubmit="UpdateEmailServerAsync">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        @if (!string.IsNullOrEmpty(emailMessage))
                        {
                            <div class="alert @(emailSuccess ? "alert-success" : "alert-danger")">@emailMessage</div>
                        }

                        <div class="mb-3">
                            <label class="form-label">Servidor SMTP</label>
                            <InputText @bind-Value="emailServer.SmtpHost" class="form-control" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Puerto</label>
                            <InputNumber @bind-Value="emailServer.Port" class="form-control" />
                        </div>

                        <div class="form-check form-switch mb-3">
                            <InputCheckbox @bind-Value="emailServer.UseSsl" class="form-check-input" id="useSsl" />
                            <label class="form-check-label" for="useSsl">Usar conexión cifrada (SSL/TLS)</label>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Usuario</label>
                            <InputText @bind-Value="emailServer.Username" class="form-control" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Correo remitente</label>
                            <InputText @bind-Value="emailServer.FromEmail" class="form-control" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Nombre remitente</label>
                            <InputText @bind-Value="emailServer.FromName" class="form-control" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Clave SMTP (dejar vacía para conservar)</label>
                            <InputText @bind-Value="emailServer.NewPassword" type="password" class="form-control" />
                            @if (emailServer.HasPassword)
                            {
                                <div class="form-text text-success">Existe una clave almacenada de forma cifrada.</div>
                            }
                        </div>

                        <button class="btn btn-primary w-100" disabled="@emailSaving">
                            @if (emailSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2">Guardando...</span>
                            }
                            else
                            {
                                <span>Actualizar servidor</span>
                            }
                        </button>
                    </EditForm>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Notificaciones automáticas</h5>
                </div>
                <div class="card-body">
                    <EditForm Model="notifications" OnValidSubmit="UpdateNotificationSettingsAsync">
                        <DataAnnotationsValidator />

                        @if (!string.IsNullOrEmpty(notificationMessage))
                        {
                            <div class="alert @(notificationSuccess ? "alert-success" : "alert-danger")">@notificationMessage</div>
                        }

                        <div class="form-check form-switch mb-3">
                            <InputCheckbox @bind-Value="notifications.SendSecurityAlerts" class="form-check-input" id="securityAlerts" />
                            <label class="form-check-label" for="securityAlerts">Enviar alertas críticas de seguridad</label>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Destinatarios alertas (separar por coma)</label>
                            <InputText @bind-Value="notifications.SecurityAlertRecipients" class="form-control" />
                        </div>

                        <div class="form-check form-switch mb-3">
                            <InputCheckbox @bind-Value="notifications.SendPasswordRecovery" class="form-check-input" id="pwdRecovery" />
                            <label class="form-check-label" for="pwdRecovery">Notificar recuperaciones de contraseña</label>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Destinatarios recuperación</label>
                            <InputText @bind-Value="notifications.PasswordRecoveryRecipients" class="form-control" />
                        </div>

                        <div class="form-check form-switch mb-3">
                            <InputCheckbox @bind-Value="notifications.SendUserInvitations" class="form-check-input" id="userInvites" />
                            <label class="form-check-label" for="userInvites">Enviar invitaciones y altas de usuarios</label>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Destinatarios invitaciones</label>
                            <InputText @bind-Value="notifications.UserInvitationRecipients" class="form-control" />
                        </div>

                        <button class="btn btn-primary w-100" disabled="@notificationsSaving">
                            @if (notificationsSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2">Guardando...</span>
                            }
                            else
                            {
                                <span>Actualizar notificaciones</span>
                            }
                        </button>
                    </EditForm>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Seguridad de acceso</h5>
                </div>
                <div class="card-body">
                    <EditForm Model="tokenSettings" OnValidSubmit="UpdateTokenSettingsAsync">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        @if (!string.IsNullOrEmpty(tokenMessage))
                        {
                            <div class="alert @(tokenSuccess ? "alert-success" : "alert-danger")">@tokenMessage</div>
                        }

                        <div class="mb-3">
                            <label class="form-label">Duración del token (horas)</label>
                            <InputNumber @bind-Value="tokenSettings.TokenLifetimeHours" class="form-control" />
                            <div class="form-text">Tiempo máximo antes de requerir un nuevo inicio de sesión.</div>
                        </div>

                        <button class="btn btn-primary w-100" disabled="@tokenSaving">
                            @if (tokenSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <span>Guardando...</span>
                            }
                            else
                            {
                                <span>Guardar duración de sesión</span>
                            }
                        </button>
                    </EditForm>

                    <hr class="my-4" />

                    @if (!string.IsNullOrEmpty(registrationMessage))
                    {
                        <div class="alert @(registrationSuccess ? "alert-success" : "alert-danger")">@registrationMessage</div>
                    }

                    <div class="form-check form-switch mb-3">
                        <InputCheckbox @bind-Value="registrationSettings.IsRegistrationEnabled" class="form-check-input" id="registrationToggle" />
                        <label class="form-check-label" for="registrationToggle">
                            Permitir registro público de usuarios
                        </label>
                    </div>

                    <p class="text-muted small">
                        Cuando esta opción está desactivada, solo un administrador puede dar de alta nuevas cuentas desde este panel.
                    </p>

                    <button class="btn btn-outline-primary w-100" @onclick="UpdateRegistrationSettingsAsync" disabled="@registrationSaving">
                        @if (registrationSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            Guardando cambios...
                        }
                        else
                        {
                            Guardar preferencia
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mt-1">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Motor de IA y puntajes</h5>
                </div>
                <div class="card-body">
                    <EditForm Model="aiSettings" OnValidSubmit="UpdateAIScoringSettingsAsync">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        @if (!string.IsNullOrEmpty(aiMessage))
                        {
                            <div class="alert @(aiSuccess ? "alert-success" : "alert-danger")">@aiMessage</div>
                        }

                        <div class="row g-3">
                            <div class="col-lg-4">
                                <h6 class="text-muted">Umbrales generales</h6>
                                <div class="mb-3">
                                    <label class="form-label">Umbral riesgo alto</label>
                                    <InputNumber @bind-Value="aiSettings.HighRiskThreshold" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Umbral sospechoso</label>
                                    <InputNumber @bind-Value="aiSettings.SuspiciousThreshold" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Recomendación: Bloquear</label>
                                    <InputNumber @bind-Value="aiSettings.RecommendationBlockThreshold" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Recomendación: Revisar</label>
                                    <InputNumber @bind-Value="aiSettings.RecommendationReviewThreshold" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Recomendación: Monitorear</label>
                                    <InputNumber @bind-Value="aiSettings.RecommendationMonitorThreshold" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Riesgo Alto (usuarios)</label>
                                    <InputNumber @bind-Value="aiSettings.RiskLevelHighThreshold" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Riesgo Medio (usuarios)</label>
                                    <InputNumber @bind-Value="aiSettings.RiskLevelMediumThreshold" class="form-control" />
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <h6 class="text-muted">Puntajes de archivo</h6>
                                <div class="mb-3">
                                    <label class="form-label">Puntos extensión sospechosa</label>
                                    <InputNumber @bind-Value="aiSettings.SuspiciousExtensionScore" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Puntos archivo grande</label>
                                    <InputNumber @bind-Value="aiSettings.LargeFileScore" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Puntos fuera de horario</label>
                                    <InputNumber @bind-Value="aiSettings.OutsideBusinessHoursScore" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Puntos carga inusual</label>
                                    <InputNumber @bind-Value="aiSettings.UnusualUploadsScore" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Puntos tamaño inusual</label>
                                    <InputNumber @bind-Value="aiSettings.UnusualFileSizeScore" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Puntos acceso fuera de horario</label>
                                    <InputNumber @bind-Value="aiSettings.OutsideHoursBehaviorScore" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Incremento por actividad inusual</label>
                                    <InputNumber @bind-Value="aiSettings.UnusualActivityIncrement" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Peso prob. malware</label>
                                    <InputNumber @bind-Value="aiSettings.MalwareProbabilityWeight" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Peso prob. exfiltración</label>
                                    <InputNumber @bind-Value="aiSettings.DataExfiltrationWeight" class="form-control" />
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <h6 class="text-muted">Comportamiento y límites</h6>
                                <div class="row g-3">
                                    <div class="col-6">
                                        <label class="form-label">Hora inicio</label>
                                        <InputNumber @bind-Value="aiSettings.BusinessHoursStart" class="form-control" />
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">Hora fin</label>
                                        <InputNumber @bind-Value="aiSettings.BusinessHoursEnd" class="form-control" />
                                    </div>
                                </div>
                                <div class="mb-3 mt-3">
                                    <label class="form-label">Multiplicador carga inusual</label>
                                    <InputNumber @bind-Value="aiSettings.UploadAnomalyMultiplier" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Multiplicador tamaño inusual</label>
                                    <InputNumber @bind-Value="aiSettings.FileSizeAnomalyMultiplier" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Tamaño máximo evaluado (MB)</label>
                                    <InputNumber @bind-Value="aiSettings.MaxFileSizeMB" class="form-control" />
                                </div>
                                <h6 class="text-muted mt-4">Pesos avanzados</h6>
                                <div class="mb-3">
                                    <label class="form-label">Peso extensión peligrosa</label>
                                    <InputNumber @bind-Value="aiSettings.MalwareSuspiciousExtensionWeight" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Peso palabra "crack"</label>
                                    <InputNumber @bind-Value="aiSettings.MalwareCrackKeywordWeight" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Peso palabra "keygen"</label>
                                    <InputNumber @bind-Value="aiSettings.MalwareKeygenKeywordWeight" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Peso ejecutables</label>
                                    <InputNumber @bind-Value="aiSettings.MalwareExecutableWeight" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Umbral archivo grande (MB)</label>
                                    <InputNumber @bind-Value="aiSettings.DataExfiltrationLargeFileMB" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Umbral archivo muy grande (MB)</label>
                                    <InputNumber @bind-Value="aiSettings.DataExfiltrationHugeFileMB" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Peso archivo grande</label>
                                    <InputNumber @bind-Value="aiSettings.DataExfiltrationLargeFileWeight" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Peso archivo muy grande</label>
                                    <InputNumber @bind-Value="aiSettings.DataExfiltrationHugeFileWeight" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Peso archivos comprimidos</label>
                                    <InputNumber @bind-Value="aiSettings.DataExfiltrationArchiveWeight" class="form-control" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Peso actividad fuera de horario</label>
                                    <InputNumber @bind-Value="aiSettings.DataExfiltrationOffHoursWeight" class="form-control" />
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Extensiones sospechosas (separar por coma)</label>
                            <InputTextArea @bind-Value="aiSettings.SuspiciousExtensions" class="form-control" rows="3" />
                        </div>

                        <button class="btn btn-primary" disabled="@aiSaving">
                            @if (aiSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                Guardando IA...
                            }
                            else
                            {
                                Guardar configuración avanzada
                            }
                        </button>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private FileStorageSettings storageSettings = new();
    private EmailServerSettingsDto emailServer = new();
    private EmailNotificationSettingsDto notifications = new();
    private RegistrationSettingsDto registrationSettings = new();
    private TokenSettingsDto tokenSettings = new();
    private AIScoringSettingsDto aiSettings = new();

    private bool isLoading = true;
    private bool storageSaving;
    private bool emailSaving;
    private bool notificationsSaving;
    private bool registrationSaving;
    private bool tokenSaving;
    private bool aiSaving;

    private string? storageMessage;
    private bool storageSuccess;
    private string? emailMessage;
    private bool emailSuccess;
    private string? notificationMessage;
    private bool notificationSuccess;
    private string? registrationMessage;
    private bool registrationSuccess;
    private string? tokenMessage;
    private bool tokenSuccess;
    private string? aiMessage;
    private bool aiSuccess;

    protected override async Task OnInitializedAsync()
    {
        await LoadSettingsAsync();
    }

    private async Task LoadSettingsAsync()
    {
        try
        {
            storageSettings = await SettingsService.GetStorageSettingsAsync() ?? new FileStorageSettings();
            emailServer = await SettingsService.GetEmailServerSettingsAsync() ?? new EmailServerSettingsDto();
            notifications = await SettingsService.GetEmailNotificationSettingsAsync() ?? new EmailNotificationSettingsDto();
            registrationSettings = await SettingsService.GetRegistrationSettingsAsync() ?? new RegistrationSettingsDto();
            tokenSettings = await SettingsService.GetTokenSettingsAsync() ?? new TokenSettingsDto();
            aiSettings = await SettingsService.GetAIScoringSettingsAsync() ?? new AIScoringSettingsDto();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task UpdateStorageSettingsAsync()
    {
        storageMessage = null;
        storageSaving = true;
        try
        {
            storageSuccess = await SettingsService.UpdateStorageSettingsAsync(storageSettings);
            storageMessage = storageSuccess ? "Política de almacenamiento actualizada." : "No se pudo guardar la configuración de almacenamiento.";
            if (storageSuccess)
            {
                var refreshed = await SettingsService.GetStorageSettingsAsync();
                if (refreshed is not null)
                {
                    storageSettings = refreshed;
                }
            }
        }
        finally
        {
            storageSaving = false;
        }
    }

    private async Task UpdateEmailServerAsync()
    {
        emailMessage = null;
        emailSaving = true;
        try
        {
            emailSuccess = await SettingsService.UpdateEmailServerSettingsAsync(emailServer);
            emailMessage = emailSuccess ? "Servidor SMTP actualizado." : "No fue posible guardar el servidor SMTP.";
            if (emailSuccess)
            {
                emailServer.NewPassword = string.Empty;
                var refreshed = await SettingsService.GetEmailServerSettingsAsync();
                if (refreshed is not null)
                {
                    emailServer = refreshed;
                }
            }
        }
        finally
        {
            emailSaving = false;
        }
    }

    private async Task UpdateNotificationSettingsAsync()
    {
        notificationMessage = null;
        notificationsSaving = true;
        try
        {
            notificationSuccess = await SettingsService.UpdateEmailNotificationSettingsAsync(notifications);
            notificationMessage = notificationSuccess ? "Destinatarios actualizados." : "No pudimos guardar las notificaciones.";
            if (notificationSuccess)
            {
                var refreshed = await SettingsService.GetEmailNotificationSettingsAsync();
                if (refreshed is not null)
                {
                    notifications = refreshed;
                }
            }
        }
        finally
        {
            notificationsSaving = false;
        }
    }

    private async Task UpdateTokenSettingsAsync()
    {
        tokenMessage = null;
        tokenSaving = true;

        try
        {
            tokenSuccess = await SettingsService.UpdateTokenSettingsAsync(tokenSettings);
            tokenMessage = tokenSuccess
                ? "Duración de sesión actualizada."
                : "No se pudo actualizar la duración del token.";

            if (tokenSuccess)
            {
                var refreshed = await SettingsService.GetTokenSettingsAsync();
                if (refreshed is not null)
                {
                    tokenSettings = refreshed;
                }
            }
        }
        finally
        {
            tokenSaving = false;
        }
    }

    private async Task UpdateAIScoringSettingsAsync()
    {
        aiMessage = null;
        aiSaving = true;

        try
        {
            aiSuccess = await SettingsService.UpdateAIScoringSettingsAsync(aiSettings);
            aiMessage = aiSuccess
                ? "Configuración de IA actualizada."
                : "No fue posible guardar los parámetros de IA.";

            if (aiSuccess)
            {
                var refreshed = await SettingsService.GetAIScoringSettingsAsync();
                if (refreshed is not null)
                {
                    aiSettings = refreshed;
                }
            }
        }
        finally
        {
            aiSaving = false;
        }
    }

    private async Task UpdateRegistrationSettingsAsync()
    {
        registrationMessage = null;
        registrationSaving = true;

        try
        {
            registrationSuccess = await SettingsService.UpdateRegistrationSettingsAsync(registrationSettings.IsRegistrationEnabled);
            registrationMessage = registrationSuccess
                ? (registrationSettings.IsRegistrationEnabled
                    ? "El registro público está habilitado."
                    : "El registro público fue deshabilitado.")
                : "No se pudo actualizar la preferencia de registro.";

            if (registrationSuccess)
            {
                var refreshed = await SettingsService.GetRegistrationSettingsAsync();
                if (refreshed is not null)
                {
                    registrationSettings = refreshed;
                }
            }
        }
        finally
        {
            registrationSaving = false;
        }
    }
}
