@page "/settings"
@attribute [Authorize(Roles = "Admin")]
@using Microsoft.AspNetCore.Authorization
@using ConfidentialBox.Core.Configuration
@using ConfidentialBox.Core.DTOs
@inject ISettingsService SettingsService

<PageTitle>Configuración avanzada - ConfidentialBox</PageTitle>

<h1 class="mb-4"><i class="fas fa-cogs"></i> Configuración de la plataforma</h1>

@if (isLoading)
{
    <div class="text-center my-5">
        <div class="spinner-border" role="status"></div>
        <p class="mt-3">Cargando ajustes seguros...</p>
    </div>
}
else
{
    <div class="card shadow-sm">
        <div class="card-header bg-white border-bottom">
            <ul class="nav nav-tabs card-header-tabs">
                <li class="nav-item">
                    <button type="button" class="nav-link @(activeTab == "storage" ? "active" : string.Empty)" @onclick="() => SetActiveTab("storage")">
                        <i class="fas fa-database"></i> Almacenamiento
                    </button>
                </li>
                <li class="nav-item">
                    <button type="button" class="nav-link @(activeTab == "email" ? "active" : string.Empty)" @onclick="() => SetActiveTab("email")">
                        <i class="fas fa-envelope"></i> Correo seguro
                    </button>
                </li>
                <li class="nav-item">
                    <button type="button" class="nav-link @(activeTab == "notifications" ? "active" : string.Empty)" @onclick="() => SetActiveTab("notifications")">
                        <i class="fas fa-bell"></i> Notificaciones
                    </button>
                </li>
                <li class="nav-item">
                    <button type="button" class="nav-link @(activeTab == "security" ? "active" : string.Empty)" @onclick="() => SetActiveTab("security")">
                        <i class="fas fa-user-shield"></i> Seguridad de acceso
                    </button>
                </li>
            </ul>
        </div>
        <div class="card-body">
            @switch (activeTab)
            {
                case "storage":
                    <div class="row g-4">
                        <div class="col-lg-7">
                            <EditForm Model="storageSettings" OnValidSubmit="UpdateStorageSettingsAsync">
                                <DataAnnotationsValidator />

                                @if (!string.IsNullOrEmpty(storageMessage))
                                {
                                    <div class="alert @(storageSuccess ? "alert-success" : "alert-danger")">@storageMessage</div>
                                }

                                <div class="form-check form-switch mb-3">
                                    <InputCheckbox @bind-Value="storageSettings.StoreInDatabase" class="form-check-input" id="dbStorage" />
                                    <label class="form-check-label" for="dbStorage">Guardar en base de datos encriptada</label>
                                </div>

                                <div class="form-check form-switch mb-3">
                                    <InputCheckbox @bind-Value="storageSettings.StoreOnFileSystem" class="form-check-input" id="fsStorage" />
                                    <label class="form-check-label" for="fsStorage">Guardar en almacenamiento seguro del servidor</label>
                                </div>

                                <div class="form-check form-switch mb-3">
                                    <InputCheckbox @bind-Value="storageSettings.UseUserScopedDirectories" class="form-check-input" id="userDirs" />
                                    <label class="form-check-label" for="userDirs">Crear carpetas aisladas por usuario</label>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Directorio seguro</label>
                                    <InputText @bind-Value="storageSettings.FileSystemDirectory" class="form-control" />
                                    <div class="form-text">Ruta local o UNC con permisos restringidos. Se crea automáticamente si no existe.</div>
                                </div>

                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Límite total (GB)</label>
                                        <InputNumber @bind-Value="storageSettings.TotalStorageLimitGb" class="form-control" min="0" />
                                        <div class="form-text">0 = ilimitado. Controla el uso de disco global.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Límite por usuario (GB)</label>
                                        <InputNumber @bind-Value="storageSettings.PerUserStorageLimitGb" class="form-control" min="0" />
                                        <div class="form-text">0 = ilimitado. Cuota individual por cuenta.</div>
                                    </div>
                                </div>

                                <button class="btn btn-primary" disabled="@storageSaving">
                                    @if (storageSaving)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                        Guardando…
                                    }
                                    else
                                    {
                                        <span>Actualizar almacenamiento</span>
                                    }
                                </button>
                            </EditForm>
                        </div>
                        <div class="col-lg-5">
                            <div class="alert alert-info">
                                <h6 class="fw-semibold"><i class="fas fa-info-circle"></i> Resumen</h6>
                                <ul class="small mb-0">
                                    <li>Las cuotas se aplican antes de aceptar nuevas subidas.</li>
                                    <li>Las carpetas por usuario evitan colisiones y simplifican auditorías.</li>
                                    <li>Siempre puedes combinar base de datos + sistema de archivos para redundancia.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    break;
                case "email":
                    <EditForm Model="emailServer" OnValidSubmit="UpdateEmailServerAsync">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        @if (!string.IsNullOrEmpty(emailMessage))
                        {
                            <div class="alert @(emailSuccess ? "alert-success" : "alert-danger")">@emailMessage</div>
                        }

                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label">Servidor SMTP</label>
                                <InputText @bind-Value="emailServer.SmtpHost" class="form-control" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Puerto</label>
                                <InputNumber @bind-Value="emailServer.Port" class="form-control" />
                            </div>
                        </div>

                        <div class="form-check form-switch my-3">
                            <InputCheckbox @bind-Value="emailServer.UseSsl" class="form-check-input" id="useSsl" />
                            <label class="form-check-label" for="useSsl">Usar conexión cifrada (SSL/TLS)</label>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Usuario</label>
                                <InputText @bind-Value="emailServer.Username" class="form-control" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Correo remitente</label>
                                <InputText @bind-Value="emailServer.FromEmail" class="form-control" />
                            </div>
                        </div>

                        <div class="row g-3 mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Nombre remitente</label>
                                <InputText @bind-Value="emailServer.FromName" class="form-control" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Clave SMTP (dejar vacía para conservar)</label>
                                <InputText @bind-Value="emailServer.NewPassword" type="password" class="form-control" />
                                @if (emailServer.HasPassword)
                                {
                                    <div class="form-text text-success">Existe una clave almacenada de forma cifrada.</div>
                                }
                            </div>
                        </div>

                        <button class="btn btn-primary mt-4" disabled="@emailSaving">
                            @if (emailSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>Guardando…
                            }
                            else
                            {
                                <span>Actualizar servidor</span>
                            }
                        </button>
                    </EditForm>
                    break;
                case "notifications":
                    <EditForm Model="notifications" OnValidSubmit="UpdateNotificationSettingsAsync">
                        <DataAnnotationsValidator />

                        @if (!string.IsNullOrEmpty(notificationMessage))
                        {
                            <div class="alert @(notificationSuccess ? "alert-success" : "alert-danger")">@notificationMessage</div>
                        }

                        <div class="form-check form-switch mb-3">
                            <InputCheckbox @bind-Value="notifications.SendSecurityAlerts" class="form-check-input" id="securityAlerts" />
                            <label class="form-check-label" for="securityAlerts">Enviar alertas críticas de seguridad</label>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Destinatarios alertas (separar por coma)</label>
                            <InputText @bind-Value="notifications.SecurityAlertRecipients" class="form-control" />
                        </div>

                        <div class="form-check form-switch mb-3">
                            <InputCheckbox @bind-Value="notifications.SendPasswordRecovery" class="form-check-input" id="pwdRecovery" />
                            <label class="form-check-label" for="pwdRecovery">Notificar recuperaciones de contraseña</label>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Destinatarios recuperación</label>
                            <InputText @bind-Value="notifications.PasswordRecoveryRecipients" class="form-control" />
                        </div>

                        <div class="form-check form-switch mb-3">
                            <InputCheckbox @bind-Value="notifications.SendUserInvitations" class="form-check-input" id="userInvites" />
                            <label class="form-check-label" for="userInvites">Enviar invitaciones y altas de usuarios</label>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Destinatarios invitaciones</label>
                            <InputText @bind-Value="notifications.UserInvitationRecipients" class="form-control" />
                        </div>

                        <button class="btn btn-primary" disabled="@notificationsSaving">
                            @if (notificationsSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>Guardando…
                            }
                            else
                            {
                                <span>Actualizar notificaciones</span>
                            }
                        </button>
                    </EditForm>
                    break;
                case "security":
                    <div class="row g-4">
                        <div class="col-lg-6">
                            <EditForm Model="tokenSettings" OnValidSubmit="UpdateTokenSettingsAsync">
                                <DataAnnotationsValidator />
                                <ValidationSummary />

                                @if (!string.IsNullOrEmpty(tokenMessage))
                                {
                                    <div class="alert @(tokenSuccess ? "alert-success" : "alert-danger")">@tokenMessage</div>
                                }

                                <div class="mb-3">
                                    <label class="form-label">Duración del token (horas)</label>
                                    <InputNumber @bind-Value="tokenSettings.TokenLifetimeHours" class="form-control" min="1" />
                                    <div class="form-text">Tiempo máximo antes de requerir un nuevo inicio de sesión.</div>
                                </div>

                                <button class="btn btn-primary" disabled="@tokenSaving">
                                    @if (tokenSaving)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>Guardando…
                                    }
                                    else
                                    {
                                        <span>Guardar duración de sesión</span>
                                    }
                                </button>
                            </EditForm>
                        </div>
                        <div class="col-lg-6">
                            <div class="card border-0 h-100 bg-light">
                                <div class="card-body">
                                    @if (!string.IsNullOrEmpty(registrationMessage))
                                    {
                                        <div class="alert @(registrationSuccess ? "alert-success" : "alert-danger")">@registrationMessage</div>
                                    }

                                    <div class="form-check form-switch mb-3">
                                        <InputCheckbox @bind-Value="registrationSettings.IsRegistrationEnabled" class="form-check-input" id="registrationToggle" />
                                        <label class="form-check-label" for="registrationToggle">
                                            Permitir registro público de usuarios
                                        </label>
                                    </div>

                                    <p class="text-muted small">
                                        Cuando esta opción está desactivada, solo un administrador puede dar de alta nuevas cuentas desde este panel.
                                    </p>

                                    <button class="btn btn-outline-primary" @onclick="UpdateRegistrationSettingsAsync" disabled="@registrationSaving">
                                        @if (registrationSaving)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2"></span>Guardando…
                                        }
                                        else
                                        {
                                            <span>Guardar preferencia</span>
                                        }
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    break;
            }
        </div>
    </div>
}

@code {
    private FileStorageSettings storageSettings = new();
    private EmailServerSettingsDto emailServer = new();
    private EmailNotificationSettingsDto notifications = new();
    private RegistrationSettingsDto registrationSettings = new();
    private TokenSettingsDto tokenSettings = new();

    private bool isLoading = true;
    private bool storageSaving;
    private bool emailSaving;
    private bool notificationsSaving;
    private bool registrationSaving;
    private bool tokenSaving;

    private string? storageMessage;
    private bool storageSuccess;
    private string? emailMessage;
    private bool emailSuccess;
    private string? notificationMessage;
    private bool notificationSuccess;
    private string? registrationMessage;
    private bool registrationSuccess;
    private string? tokenMessage;
    private bool tokenSuccess;

    private string activeTab = "storage";

    protected override async Task OnInitializedAsync()
    {
        await LoadSettingsAsync();
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
    }

    private async Task LoadSettingsAsync()
    {
        try
        {
            storageSettings = await SettingsService.GetStorageSettingsAsync() ?? new FileStorageSettings();
            emailServer = await SettingsService.GetEmailServerSettingsAsync() ?? new EmailServerSettingsDto();
            notifications = await SettingsService.GetEmailNotificationSettingsAsync() ?? new EmailNotificationSettingsDto();
            registrationSettings = await SettingsService.GetRegistrationSettingsAsync() ?? new RegistrationSettingsDto();
            tokenSettings = await SettingsService.GetTokenSettingsAsync() ?? new TokenSettingsDto();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task UpdateStorageSettingsAsync()
    {
        storageMessage = null;
        storageSaving = true;
        try
        {
            storageSuccess = await SettingsService.UpdateStorageSettingsAsync(storageSettings);
            storageMessage = storageSuccess ? "Política de almacenamiento actualizada." : "No se pudo guardar la configuración de almacenamiento.";
            if (storageSuccess)
            {
                var refreshed = await SettingsService.GetStorageSettingsAsync();
                if (refreshed is not null)
                {
                    storageSettings = refreshed;
                }
            }
        }
        finally
        {
            storageSaving = false;
        }
    }

    private async Task UpdateEmailServerAsync()
    {
        emailMessage = null;
        emailSaving = true;
        try
        {
            emailSuccess = await SettingsService.UpdateEmailServerSettingsAsync(emailServer);
            emailMessage = emailSuccess ? "Servidor actualizado." : "No fue posible actualizar el servidor.";
            if (emailSuccess)
            {
                emailServer.NewPassword = string.Empty;
                var refreshed = await SettingsService.GetEmailServerSettingsAsync();
                if (refreshed is not null)
                {
                    emailServer = refreshed;
                }
            }
        }
        finally
        {
            emailSaving = false;
        }
    }

    private async Task UpdateNotificationSettingsAsync()
    {
        notificationMessage = null;
        notificationsSaving = true;
        try
        {
            notificationSuccess = await SettingsService.UpdateEmailNotificationSettingsAsync(notifications);
            notificationMessage = notificationSuccess ? "Destinatarios actualizados." : "No pudimos guardar las notificaciones.";
            if (notificationSuccess)
            {
                var refreshed = await SettingsService.GetEmailNotificationSettingsAsync();
                if (refreshed is not null)
                {
                    notifications = refreshed;
                }
            }
        }
        finally
        {
            notificationsSaving = false;
        }
    }

    private async Task UpdateTokenSettingsAsync()
    {
        tokenMessage = null;
        tokenSaving = true;

        try
        {
            tokenSuccess = await SettingsService.UpdateTokenSettingsAsync(tokenSettings);
            tokenMessage = tokenSuccess
                ? "Duración de sesión actualizada."
                : "No se pudo actualizar la duración del token.";

            if (tokenSuccess)
            {
                var refreshed = await SettingsService.GetTokenSettingsAsync();
                if (refreshed is not null)
                {
                    tokenSettings = refreshed;
                }
            }
        }
        finally
        {
            tokenSaving = false;
        }
    }

    private async Task UpdateRegistrationSettingsAsync()
    {
        registrationMessage = null;
        registrationSaving = true;

        try
        {
            registrationSuccess = await SettingsService.UpdateRegistrationSettingsAsync(registrationSettings.IsRegistrationEnabled);
            registrationMessage = registrationSuccess
                ? (registrationSettings.IsRegistrationEnabled
                    ? "El registro público está habilitado."
                    : "El registro público fue deshabilitado.")
                : "No se pudo actualizar la preferencia de registro.";

            if (registrationSuccess)
            {
                var refreshed = await SettingsService.GetRegistrationSettingsAsync();
                if (refreshed is not null)
                {
                    registrationSettings = refreshed;
                }
            }
        }
        finally
        {
            registrationSaving = false;
        }
    }
}
