@page "/security-alerts"
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.WebUtilities
@using ConfidentialBox.Core.DTOs
@using System.Globalization
@using System.Linq
@using System.Text.Json
@attribute [Authorize(Roles = "Admin")]
@inject HttpClient Http
@inject NavigationManager NavigationManager

<PageTitle>Alertas de Seguridad - ConfidentialBox</PageTitle>

<h1 class="d-flex align-items-center gap-2 mb-0">
    <i class="fas fa-shield-alt text-danger"></i>
    <span>Alertas de Seguridad</span>
</h1>
<p class="text-muted">Monitorea, filtra y actúa sobre los incidentes detectados por la IA en tiempo real.</p>

@if (!string.IsNullOrEmpty(error))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>@error
        <button type="button" class="btn-close" @onclick="() => error = null"></button>
    </div>
}

<div class="card shadow-sm mt-4">
    <div class="card-header bg-white">
        <div class="d-flex flex-wrap gap-3 justify-content-between align-items-center">
            <div class="d-flex flex-wrap gap-3">
                <span class="badge rounded-pill text-bg-danger-subtle text-danger fw-semibold px-3 py-2">
                    <i class="fas fa-bell me-1"></i> Nuevas alertas: @((summary?.NewAlerts ?? 0).ToString(CultureInfo.InvariantCulture))
                </span>
                @if (summary?.SeverityCounts?.Any() == true)
                {
                    foreach (var pair in summary.SeverityCounts.OrderByDescending(p => SeverityOrder(p.Key)))
                    {
                        <span class="badge rounded-pill bg-light text-dark border">
                            <i class="fas fa-signal me-1"></i>@pair.Key: @pair.Value
                        </span>
                    }
                }
            </div>
            <button class="btn btn-outline-secondary btn-sm" @onclick="RefreshAsync">
                <i class="fas fa-sync-alt"></i> Actualizar
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-12">
                <label class="form-label">Búsqueda rápida</label>
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
                    <InputText class="form-control" @bind-Value="filterKeyword" placeholder="Buscar por usuario, archivo, descripción o nota" />
                    <button class="btn btn-outline-primary" @onclick="ApplyFilters"><i class="fas fa-magnifying-glass"></i> Buscar</button>
                </div>
                <small class="text-muted">Vuelve el filtro de búsqueda: combina coincidencias sobre usuario, archivo, descripción y notas.</small>
            </div>
            <div class="col-md-3">
                <label class="form-label">Severidad</label>
                <InputSelect class="form-select" @bind-Value="filterSeverity">
                    <option value="">Todas</option>
                    @foreach (var level in SeverityOptions)
                    {
                        <option value="@level">@level</option>
                    }
                </InputSelect>
            </div>
            <div class="col-md-3">
                <label class="form-label">Usuario</label>
                <InputSelect class="form-select" @bind-Value="filterUserId">
                    <option value="">Todos</option>
                    @foreach (var user in availableUsers)
                    {
                        <option value="@user.Id">@user.FullName (@user.Email)</option>
                    }
                </InputSelect>
            </div>
            <div class="col-md-3">
                <label class="form-label">Tipo de alerta</label>
                <InputText class="form-control" @bind-Value="filterType" placeholder="Ej. SuspiciousFile" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Archivo involucrado</label>
                <InputText class="form-control" @bind-Value="filterFileName" placeholder="Nombre del archivo" />
            </div>
            <div class="col-md-6">
                <label class="form-label">Descripción / palabra clave</label>
                <InputText class="form-control" @bind-Value="filterDescription" placeholder="Motivo, patrón o detalle" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Desde</label>
                <InputDate class="form-control" @bind-Value="filterFrom" TValue="DateTime?" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Hasta</label>
                <InputDate class="form-control" @bind-Value="filterTo" TValue="DateTime?" />
            </div>
            <div class="col-12 d-flex flex-wrap gap-2">
                <button class="btn btn-primary" @onclick="ApplyFilters">
                    <i class="fas fa-filter me-1"></i> Aplicar filtros
                </button>
                <button class="btn btn-outline-secondary" @onclick="ResetFilters">
                    <i class="fas fa-eraser me-1"></i> Limpiar
                </button>
            </div>
        </div>

        <ul class="nav nav-pills mt-4 mb-3 flex-wrap gap-2">
            @foreach (var tab in StatusTabs)
            {
                var isActive = activeStatusTab.Equals(tab.Key, StringComparison.OrdinalIgnoreCase);
                var badgeClass = isActive ? "bg-white text-primary" : "bg-light text-dark";
                <li class="nav-item">
                    <button type="button"
                            class='nav-link d-flex align-items-center gap-2 @(isActive ? "active" : string.Empty)'
                            @onclick="() => ChangeStatusTab(tab.Key)">
                        <span>@tab.Value</span>
                        <span class="badge @badgeClass">@GetStatusCount(tab.Key)</span>
                    </button>
                </li>
            }
        </ul>

        @if (isLoading)
        {
            <div class="text-center my-5">
                <div class="spinner-border" role="status"></div>
                <p class="mt-3 text-muted">Cargando alertas monitorizadas…</p>
            </div>
        }
        else if (alerts is null || alerts.Items.Count == 0)
        {
            <div class="alert alert-info mb-0">
                <i class="fas fa-check-circle me-2"></i>No se encontraron alertas que coincidan con los filtros seleccionados.
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Tipo</th>
                            <th>Severidad</th>
                            <th>Estado</th>
                            <th>Usuario</th>
                            <th>Archivo</th>
                            <th>Descripción</th>
                            <th>Confianza</th>
                            <th>Detectada</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var alert in alerts.Items)
                        {
                            <tr class="@(alert.IsReviewed ? string.Empty : "table-warning")">
                                <td><span class="badge bg-secondary">@alert.AlertType</span></td>
                                <td><span class="badge bg-@GetSeverityColor(alert.Severity)">@alert.Severity</span></td>
                                <td>@(RenderStatusBadgeMarkup(alert.Status))</td>
                                <td>@(string.IsNullOrWhiteSpace(alert.UserName) ? "-" : alert.UserName)</td>
                                <td>@(string.IsNullOrWhiteSpace(alert.FileName) ? "-" : alert.FileName)</td>
                                <td style="max-width: 280px;"><small>@alert.Description</small></td>
                                <td>@($"{alert.ConfidenceScore * 100:F0}%")</td>
                                <td>@alert.DetectedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                                <td class="text-end">
                                    <button class="btn btn-sm btn-primary" @onclick="() => ShowReviewModal(alert)">
                                        <i class="fas fa-clipboard-check"></i> Revisar
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <nav class="mt-3">
                <ul class="pagination justify-content-center">
                    <li class="page-item @(alerts.HasPreviousPage ? string.Empty : "disabled")">
                        <button class="page-link" @onclick="() => ChangePage(alerts.PageNumber - 1)" disabled="@(!alerts.HasPreviousPage)">
                            Anterior
                        </button>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-link">Página @alerts.PageNumber de @alerts.TotalPages</span>
                    </li>
                    <li class="page-item @(alerts.HasNextPage ? string.Empty : "disabled")">
                        <button class="page-link" @onclick="() => ChangePage(alerts.PageNumber + 1)" disabled="@(!alerts.HasNextPage)">
                            Siguiente
                        </button>
                    </li>
                </ul>
            </nav>
        }
    </div>
</div>

@if (showReviewModal && selectedAlert != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(15, 23, 42, 0.65);">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h5 class="modal-title d-flex align-items-center gap-2">
                            <i class="fas fa-clipboard-list text-primary"></i>
                            <span>Revisar alerta @("#" + selectedAlert.Id)</span>
                        </h5>
                        <small class="text-muted">Detectada el @selectedAlert.DetectedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</small>
                    </div>
                    <button type="button" class="btn-close" @onclick="CloseReviewModal"></button>
                </div>
                <div class="modal-body">
                    @if (detailLoading)
                    {
                        <div class="text-center my-4">
                            <div class="spinner-border" role="status"></div>
                            <p class="mt-2 text-muted">Recuperando detalles y auditoría…</p>
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(reviewError) && alertDetail is null)
                    {
                        <div class="alert alert-danger">@reviewError</div>
                    }
                    else if (alertDetail is not null)
                    {
                        <div class="alert alert-warning d-flex align-items-center gap-2" role="alert">
                            <i class="fas fa-bolt text-danger"></i>
                            <div class="flex-fill">
                                <div class="fw-semibold">Centro de respuesta</div>
                                <small>Ejecuta acciones directas sin salir del modal: bloquear usuarios o archivos, escalar monitoreo o enviar mensajes inmediatos.</small>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-sm btn-outline-danger"
                                        @onclick='() => ExecuteQuickAction("blockUser")'
                                        disabled="@(string.IsNullOrEmpty(selectedAlert?.UserId))">
                                    <i class="fas fa-user-slash me-1"></i>Bloquear usuario
                                </button>

                                <button class="btn btn-sm btn-outline-danger"
                                        @onclick='() => ExecuteQuickAction("blockFile")'
                                        disabled="@(selectedAlert?.FileId is null)">
                                    <i class="fas fa-file-shield me-1"></i>Aislar archivo
                                </button>

                                <button class="btn btn-sm btn-outline-warning"
                                        @onclick='() => ExecuteQuickAction("escalate")'>
                                    <i class="fas fa-satellite-dish me-1"></i>Escalar seguimiento
                                </button>

                                <button class="btn btn-sm btn-outline-primary"
                                        @onclick='() => ExecuteQuickAction("message")'
                                        disabled="@(string.IsNullOrEmpty(selectedAlert?.UserId))">
                                    <i class="fas fa-comment-dots me-1"></i>Contactar usuario
                                </button>

                                <button class="btn btn-sm btn-outline-success"
                                        @onclick='() => ExecuteQuickAction("resolve")'>
                                    <i class="fas fa-check me-1"></i>Resolver
                                </button>

                                <button class="btn btn-sm btn-outline-secondary"
                                        @onclick='() => ExecuteQuickAction("falsePositive")'>
                                    <i class="fas fa-ban me-1"></i>Falso positivo
                                </button>

                                <button class="btn btn-sm btn-dark"
                                        @onclick='() => ExecuteQuickAction("lockdown")'
                                        disabled="@(selectedAlert?.UserId is null && selectedAlert?.FileId is null)">
                                    <i class="fas fa-robot me-1"></i>Modo contención total
                                </button>
                            </div>
                        </div>



                        <div class="row g-4">
                            <div class="col-lg-7">
                                <div class="border rounded p-3 h-100">
                                    <h6 class="fw-semibold mb-3">Resumen de la alerta</h6>
                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                        <span class="badge bg-secondary"><i class="fas fa-tag me-1"></i>@alertDetail.Alert.AlertType</span>
                                        <span class="badge bg-@GetSeverityColor(alertDetail.Alert.Severity)">@alertDetail.Alert.Severity</span>
                                        @(RenderStatusBadgeMarkup(alertDetail.Alert.Status))
                                        <span class="badge bg-info text-dark">Confianza @($"{alertDetail.Alert.ConfidenceScore * 100:F0}%")</span>
                                    </div>
                                    <p class="mb-2"><strong>Usuario:</strong> @(string.IsNullOrWhiteSpace(alertDetail.Alert.UserName) ? "-" : alertDetail.Alert.UserName)</p>
                                    <p class="mb-2"><strong>Archivo:</strong> @(string.IsNullOrWhiteSpace(alertDetail.Alert.FileName) ? "-" : alertDetail.Alert.FileName)</p>
                                    <p class="mb-2"><strong>Descripción:</strong> @alertDetail.Alert.Description</p>
                                    @if (!string.IsNullOrWhiteSpace(alertDetail.Alert.ReviewNotes))
                                    {
                                        <div class="alert alert-info py-2"><i class="fas fa-sticky-note me-1"></i>Notas previas: @alertDetail.Alert.ReviewNotes</div>
                                    }
                                    <div class="bg-light rounded p-3 mt-3">
                                        <div class="row g-2">
                                            <div class="col-md-4"><span class="badge text-bg-dark w-100"><i class="fas fa-id-badge me-1"></i>Ticket @alertDetail.Alert.Id</span></div>
                                            <div class="col-md-4"><span class="badge text-bg-primary w-100"><i class="fas fa-stopwatch me-1"></i>@alertDetail.Alert.DetectedAt.ToLocalTime().ToString("dd/MM HH:mm")</span></div>
                                            <div class="col-md-4"><span class="badge text-bg-success w-100"><i class="fas fa-crosshairs me-1"></i>@(alertDetail.Alert.ConfidenceScore >= 0.8 ? "Alta prioridad" : "Seguimiento")</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-5">
                                <div class="border rounded p-3 h-100">
                                    <h6 class="fw-semibold mb-3">Último acceso monitorizado</h6>
                                    @if (alertDetail.LatestAccess is null)
                                    {
                                        <p class="text-muted mb-0">No hay accesos auditados para este evento.</p>
                                    }
                                    else
                                    {
                                        <ul class="list-unstyled small mb-0">
                                            <li><strong>IP:</strong> @alertDetail.LatestAccess.AccessedByIp</li>
                                            <li><strong>Dispositivo:</strong> @(string.IsNullOrWhiteSpace(alertDetail.LatestAccess.DeviceName) ? alertDetail.LatestAccess.DeviceType ?? "-" : alertDetail.LatestAccess.DeviceName)</li>
                                            <li><strong>SO / Navegador:</strong> @(string.IsNullOrWhiteSpace(alertDetail.LatestAccess.OperatingSystem) ? "-" : alertDetail.LatestAccess.OperatingSystem) / @(string.IsNullOrWhiteSpace(alertDetail.LatestAccess.Browser) ? "-" : alertDetail.LatestAccess.Browser)</li>
                                            <li><strong>Ubicación:</strong> @(string.IsNullOrWhiteSpace(alertDetail.LatestAccess.Location) ? "-" : alertDetail.LatestAccess.Location)</li>
                                            <li><strong>Fecha:</strong> @alertDetail.LatestAccess.AccessedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</li>
                                        </ul>
                                    }
                                </div>
                            </div>
                        </div>

                        <hr class="my-4" />

                        <div class="row g-4">
                            <div class="col-lg-7">
                                <h6 class="fw-semibold mb-3">Definir dictamen</h6>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Estado</label>
                                        <InputSelect class="form-select" @bind-Value="selectedStatusForReview">
                                            @foreach (var option in StatusTabs.Where(s => !s.Key.Equals("all", StringComparison.OrdinalIgnoreCase)))
                                            {
                                                <option value="@option.Key">@option.Value</option>
                                            }
                                        </InputSelect>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Dictamen</label>
                                        <InputText class="form-control" @bind-Value="reviewVerdict" placeholder="Ej. Bloqueado, Escalado, Falso positivo" />
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">Notas de revisión</label>
                                        <InputTextArea class="form-control" @bind-Value="reviewNotes" rows="3" placeholder="Descripción de hallazgos y seguimiento" />
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">Acción resumida (visible en tablero)</label>
                                        <InputText class="form-control" @bind-Value="actionTaken" placeholder="Ej. Usuario bloqueado temporalmente" />
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <h6 class="fw-semibold mb-2">Centro de acciones (modo tickets)</h6>
                                    <p class="text-muted small mb-3">Activa o combina acciones y deja trazabilidad clara para el equipo SOC.</p>
                                    <div class="row row-cols-1 row-cols-lg-3 g-3 mb-3">
                                        <div class="col">
                                            <div class="border rounded p-3 h-100">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div>
                                                        <span class="badge text-bg-warning text-dark mb-1"><i class="fas fa-user-shield me-1"></i>Usuario</span>
                                                        <h6 class="mb-0">Suspender usuario</h6>
                                                        <small class="text-muted">Bloquea el acceso y registra el motivo.</small>
                                                    </div>
                                                    <button type="button" class="btn btn-sm @(blockUserAction ? "btn-danger" : "btn-outline-danger")" @onclick="TriggerActionBlockUser"><i class="fas fa-user-lock"></i></button>
                                                </div>
                                                <div class="form-check mb-2">
                                                    <InputCheckbox class="form-check-input" id="blockUserCheck" @bind-Value="blockUserAction" disabled="@(string.IsNullOrEmpty(selectedAlert.UserId))" />
                                                    <label class="form-check-label" for="blockUserCheck">Desactivar usuario involucrado</label>
                                                </div>
                                                @if (blockUserAction)
                                                {
                                                    <InputTextArea class="form-control mb-2" @bind-Value="blockUserNotes" rows="2" placeholder="Detalle para la auditoría" />
                                                    <small class="text-muted">Se actualizará el estado a Escalada.</small>
                                                }
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="border rounded p-3 h-100">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div>
                                                        <span class="badge text-bg-dark mb-1"><i class="fas fa-key me-1"></i>Sesiones</span>
                                                        <h6 class="mb-0">Revocar sesiones activas</h6>
                                                        <small class="text-muted">Cierra sesiones y limpia tokens del usuario.</small>
                                                    </div>
                                                    <button type="button" class="btn btn-sm @(revokeSessionsAction ? "btn-dark" : "btn-outline-dark")" @onclick="TriggerRevokeSessions"><i class="fas fa-door-closed"></i></button>
                                                </div>
                                                <div class="form-check mb-2">
                                                    <InputCheckbox class="form-check-input" id="revokeSessionsCheck" @bind-Value="revokeSessionsAction" disabled="@(string.IsNullOrEmpty(selectedAlert.UserId))" />
                                                    <label class="form-check-label" for="revokeSessionsCheck">Cerrar sesiones y revocar tokens</label>
                                                </div>
                                                @if (revokeSessionsAction)
                                                {
                                                    <InputTextArea class="form-control mb-2" @bind-Value="revokeSessionNotes" rows="2" placeholder="Contexto para el cierre de sesión" />
                                                    <small class="text-muted">Incluye la caducidad de tokens sincronizada con bloqueo.</small>
                                                }
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="border rounded p-3 h-100">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div>
                                                        <span class="badge text-bg-danger mb-1"><i class="fas fa-file-shield"></i> Archivo</span>
                                                        <h6 class="mb-0">Bloquear archivo</h6>
                                                        <small class="text-muted">Congela el archivo y notifica a los propietarios.</small>
                                                    </div>
                                                    <button type="button" class="btn btn-sm @(blockFileAction ? "btn-danger" : "btn-outline-danger")" @onclick="TriggerActionBlockFile"><i class="fas fa-ban"></i></button>
                                                </div>
                                                <div class="form-check mb-2">
                                                    <InputCheckbox class="form-check-input" id="blockFileCheck" @bind-Value="blockFileAction" disabled="@(selectedAlert.FileId is null)" />
                                                    <label class="form-check-label" for="blockFileCheck">Bloquear archivo compartido</label>
                                                </div>
                                                @if (blockFileAction)
                                                {
                                                    <InputTextArea class="form-control mb-2" @bind-Value="blockFileNotes" rows="2" placeholder="Motivo del bloqueo" />
                                                    <small class="text-muted">Se notificará en el resumen como archivo aislado.</small>
                                                }
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="border rounded p-3 h-100">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div>
                                                        <span class="badge text-bg-info text-dark mb-1"><i class="fas fa-satellite-dish me-1"></i>Monitoreo</span>
                                                        <h6 class="mb-0">Escalar seguimiento</h6>
                                                        <small class="text-muted">Aumenta la sensibilidad y asigna nivel.</small>
                                                    </div>
                                                    <button type="button" class="btn btn-sm @(escalateMonitoring ? "btn-info" : "btn-outline-info") text-dark" @onclick="TriggerActionEscalate"><i class="fas fa-arrow-up"></i></button>
                                                </div>
                                                <div class="form-check mb-2">
                                                    <InputCheckbox class="form-check-input" id="escalateCheck" @bind-Value="escalateMonitoring" disabled="@(string.IsNullOrEmpty(selectedAlert.UserId))" />
                                                    <label class="form-check-label" for="escalateCheck">Aumentar nivel de seguimiento del usuario</label>
                                                </div>
                                                @if (escalateMonitoring)
                                                {
                                                    <div class="row g-2 mb-2">
                                                        <div class="col-sm-6">
                                                            <label class="form-label">Nuevo nivel</label>
                                                            <InputNumber class="form-control" @bind-Value="monitoringLevel" Min="1" />
                                                        </div>
                                                        <div class="col-sm-6">
                                                            <label class="form-label">Notas</label>
                                                            <InputText class="form-control" @bind-Value="escalationNotes" />
                                                        </div>
                                                    </div>
                                                    <small class="text-muted">Perfecto para casos críticos o reincidencias.</small>
                                                }
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="border rounded p-3 h-100">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div>
                                                        <span class="badge text-bg-success mb-1"><i class="fas fa-comment-dots me-1"></i>Usuario</span>
                                                        <h6 class="mb-0">Enviar mensaje</h6>
                                                        <small class="text-muted">Pide aclaraciones o da instrucciones.</small>
                                                    </div>
                                                    <button type="button" class="btn btn-sm @(string.IsNullOrWhiteSpace(chatMessage) ? "btn-outline-success" : "btn-success")" @onclick="PresetMessage"><i class="fas fa-paper-plane"></i></button>
                                                </div>
                                                <label class="form-label">Mensaje interno al usuario</label>
                                                <InputTextArea class="form-control" @bind-Value="chatMessage" rows="2" placeholder="Consulta o aviso para el usuario (opcional)" />
                                                <small class="text-muted">Se deja como ticket y se envía a través del canal interno.</small>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="border rounded p-3 h-100">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div>
                                                        <span class="badge text-bg-primary mb-1"><i class="fas fa-fingerprint me-1"></i>Identidad</span>
                                                        <h6 class="mb-0">Forzar MFA + reset</h6>
                                                        <small class="text-muted">Solicita MFA inmediato y reinicio de clave.</small>
                                                    </div>
                                                    <button type="button" class="btn btn-sm @(forceMfaAction ? "btn-primary" : "btn-outline-primary")" @onclick="TriggerForceMfa"><i class="fas fa-lock"></i></button>
                                                </div>
                                                <div class="form-check mb-2">
                                                    <InputCheckbox class="form-check-input" id="forceMfaCheck" @bind-Value="forceMfaAction" disabled="@(string.IsNullOrEmpty(selectedAlert.UserId))" />
                                                    <label class="form-check-label" for="forceMfaCheck">Forzar reautenticación segura</label>
                                                </div>
                                                @if (forceMfaAction)
                                                {
                                                    <InputText class="form-control mb-2" @bind-Value="forceMfaNotes" placeholder="Mensaje para el usuario / auditoría" />
                                                    <small class="text-muted">Acción combinada: MFA + reset de contraseña + cierre de sesiones persistentes.</small>
                                                }
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="border rounded p-3 h-100">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div>
                                                        <span class="badge text-bg-secondary mb-1"><i class="fas fa-link-slash me-1"></i>Compartición</span>
                                                        <h6 class="mb-0">Purgar enlaces y accesos</h6>
                                                        <small class="text-muted">Revoca enlaces compartidos del archivo.</small>
                                                    </div>
                                                    <button type="button" class="btn btn-sm @(purgeShareLinksAction ? "btn-secondary" : "btn-outline-secondary")" @onclick="TriggerPurgeLinks" disabled="@(selectedAlert.FileId is null)"><i class="fas fa-scissors"></i></button>
                                                </div>
                                                <div class="form-check mb-2">
                                                    <InputCheckbox class="form-check-input" id="purgeLinksCheck" @bind-Value="purgeShareLinksAction" disabled="@(selectedAlert.FileId is null)" />
                                                    <label class="form-check-label" for="purgeLinksCheck">Eliminar enlaces públicos y revocar compartidos</label>
                                                </div>
                                                @if (purgeShareLinksAction)
                                                {
                                                    <InputText class="form-control mb-2" @bind-Value="purgeLinksNotes" placeholder="Notas de purga" />
                                                    <small class="text-muted">Se documenta en el ticket como limpieza de exposición.</small>
                                                }
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="border rounded p-3 h-100">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div>
                                                        <span class="badge text-bg-info text-dark mb-1"><i class="fas fa-eye me-1"></i>Seguimiento</span>
                                                        <h6 class="mb-0">Lista de observación</h6>
                                                        <small class="text-muted">Suma al usuario a la watchlist con caducidad.</small>
                                                    </div>
                                                    <button type="button" class="btn btn-sm @(watchlistAction ? "btn-info" : "btn-outline-info") text-dark" @onclick="TriggerWatchlist"><i class="fas fa-user-secret"></i></button>
                                                </div>
                                                <div class="form-check mb-2">
                                                    <InputCheckbox class="form-check-input" id="watchlistCheck" @bind-Value="watchlistAction" disabled="@(string.IsNullOrEmpty(selectedAlert.UserId))" />
                                                    <label class="form-check-label" for="watchlistCheck">Añadir a observación reforzada</label>
                                                </div>
                                                @if (watchlistAction)
                                                {
                                                    <InputText class="form-control mb-2" @bind-Value="watchlistReason" placeholder="Motivo / duración" />
                                                    <small class="text-muted">Ideal para reincidencias o actividad lateral sospechosa.</small>
                                                }
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="border rounded p-3 h-100">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div>
                                                        <span class="badge text-bg-success mb-1"><i class="fas fa-shield-halved me-1"></i>Evidencia</span>
                                                        <h6 class="mb-0">Preservar evidencia</h6>
                                                        <small class="text-muted">Activa snapshot y retención para forense.</small>
                                                    </div>
                                                    <button type="button" class="btn btn-sm @(preserveEvidenceAction ? "btn-success" : "btn-outline-success")" @onclick="TriggerPreserveEvidence"><i class="fas fa-hard-drive"></i></button>
                                                </div>
                                                <div class="form-check mb-2">
                                                    <InputCheckbox class="form-check-input" id="preserveEvidenceCheck" @bind-Value="preserveEvidenceAction" />
                                                    <label class="form-check-label" for="preserveEvidenceCheck">Solicitar retención de evidencia</label>
                                                </div>
                                                @if (preserveEvidenceAction)
                                                {
                                                    <InputTextArea class="form-control mb-2" @bind-Value="preserveEvidenceNotes" rows="2" placeholder="Qué preservar y por cuánto tiempo" />
                                                    <small class="text-muted">Genera ticket de cadena de custodia en el backend.</small>
                                                }
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row row-cols-1 row-cols-lg-2 g-3 mt-2">
                                        <div class="col">
                                            <div class="border rounded p-3 h-100 bg-light">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div>
                                                        <span class="badge text-bg-dark mb-1"><i class="fas fa-briefcase"></i> Caso</span>
                                                        <h6 class="mb-0">Ticket y propietario</h6>
                                                        <small class="text-muted">Abre un caso formal, asigna responsable y deja notas visibles.</small>
                                                    </div>
                                                    <button type="button" class="btn btn-sm @(openCaseAction ? "btn-dark" : "btn-outline-dark")" @onclick="ToggleCaseAction"><i class="fas fa-clipboard-check"></i></button>
                                                </div>
                                                <div class="form-check mb-2">
                                                    <InputCheckbox class="form-check-input" id="openCaseCheck" @bind-Value="openCaseAction" />
                                                    <label class="form-check-label" for="openCaseCheck">Generar ticket interno</label>
                                                </div>
                                                <div class="row g-2 mb-2">
                                                    <div class="col-md-6">
                                                        <label class="form-label">Asignar a</label>
                                                        <InputSelect class="form-select" @bind-Value="followUpOwnerId">
                                                            <option value="">Seleccionar analista</option>
                                                            @foreach (var user in availableUsers)
                                                            {
                                                                <option value="@user.Id">@user.FullName (@user.Email)</option>
                                                            }
                                                        </InputSelect>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="form-label">Responsable externo</label>
                                                        <InputText class="form-control" @bind-Value="followUpOwnerName" placeholder="Nombre si no está en la lista" />
                                                    </div>
                                                </div>
                                                <label class="form-label">Notas del caso</label>
                                                <InputTextArea class="form-control" @bind-Value="followUpNotes" rows="2" placeholder="Contexto compartido con el SOC" />
                                                <small class="text-muted">Se adjunta al ticket y viaja con el historial de acciones.</small>
                                            </div>
                                        </div>

                                        <div class="col">
                                            <div class="border rounded p-3 h-100 bg-light">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div>
                                                        <span class="badge text-bg-primary mb-1"><i class="fas fa-business-time"></i> Seguimiento</span>
                                                        <h6 class="mb-0">SLA y tareas</h6>
                                                        <small class="text-muted">Define vencimiento, prioridad y alertas para que nadie lo deje pasar.</small>
                                                    </div>
                                                    <button type="button" class="btn btn-sm @(scheduleFollowUpAction ? "btn-primary" : "btn-outline-primary")" @onclick="ToggleFollowUp"><i class="fas fa-stopwatch"></i></button>
                                                </div>
                                                <div class="form-check mb-2">
                                                    <InputCheckbox class="form-check-input" id="followUpCheck" @bind-Value="scheduleFollowUpAction" />
                                                    <label class="form-check-label" for="followUpCheck">Crear recordatorio y tarea de seguimiento</label>
                                                </div>
                                                <div class="row g-2 mb-2">
                                                    <div class="col-sm-6">
                                                        <label class="form-label">Vence</label>
                                                        <InputDate class="form-control" @bind-Value="followUpDueDate" TValue="DateTime?" />
                                                    </div>
                                                    <div class="col-sm-6">
                                                        <label class="form-label">Prioridad</label>
                                                        <InputSelect class="form-select" @bind-Value="followUpPriority">
                                                            <option value="">Seleccione prioridad</option>
                                                            <option>Crítica</option>
                                                            <option>Alta</option>
                                                            <option>Media</option>
                                                            <option>Baja</option>
                                                        </InputSelect>
                                                    </div>
                                                </div>
                                                <div class="form-check mb-2">
                                                    <InputCheckbox class="form-check-input" id="notifyCheck" @bind-Value="notifySecOpsAction" />
                                                    <label class="form-check-label" for="notifyCheck">Notificar a SecOps / IR automáticamente</label>
                                                </div>
                                                <small class="text-muted">Se registra como una tarea del caso y dispara alertas de SLA.</small>
                                            </div>
                                        </div>
                                    </div>

                            <div class="d-flex flex-wrap gap-2 mb-3">
                                <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="MarkAsFalsePositive"><i class="fas fa-thumbs-up me-1"></i>Marcar como falso positivo</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" @onclick="MarkAsResolved"><i class="fas fa-check me-1"></i>Cerrar como resuelta</button>
                                <button type="button" class="btn btn-outline-dark btn-sm" @onclick="ResetActionDeck"><i class="fas fa-rotate-left me-1"></i>Reiniciar acciones</button>
                                <button type="button" class="btn btn-outline-success btn-sm" @onclick="TriggerCaseworkPreset"><i class="fas fa-ticket-alt me-1"></i>Crear ticket y asignar</button>
                            </div>
                            <p class="small text-muted mb-0"><i class="fas fa-ticket-alt me-1"></i>Usa este tablero como un sistema de tickets: define estado, acciones automáticas y mensajes sin salir del modal.</p>
                        </div>
                    </div>

                    <div class="col-lg-5">
                        <h6 class="fw-semibold mb-3">Historial de acciones</h6>
                        @if (alertDetail.Actions.Count == 0)
                        {
                                    <p class="text-muted">Aún no se registraron acciones sobre esta alerta.</p>
                                }
                                else
                                {
                                    <div class="timeline-small">
                                        @foreach (var action in alertDetail.Actions)
                                        {
                                            <div class="timeline-item">
                                                <div class="timeline-time">@action.CreatedAt.ToLocalTime().ToString("dd/MM HH:mm")</div>
                                                <div class="timeline-body">
                                                    <strong>@action.ActionType</strong>
                                                    @if (!string.IsNullOrWhiteSpace(action.Notes))
                                                    {
                                                        <div>@action.Notes</div>
                                                    }
                                                    <small class="text-muted">@(string.IsNullOrWhiteSpace(action.CreatedByUserName) ? "Sistema" : action.CreatedByUserName)</small>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(reviewError) && alertDetail is not null)
                    {
                        <div class="alert alert-danger mt-3">@reviewError</div>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" @onclick="CloseReviewModal" disabled="@reviewSubmitting">Cancelar</button>
                    <button class="btn btn-primary" @onclick="SubmitReview" disabled="@reviewSubmitting">
                        @if (reviewSubmitting)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        }
                        Guardar dictamen
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    private const int PageSize = 20;
    private readonly Dictionary<string, string> StatusTabs = new(StringComparer.OrdinalIgnoreCase)
    {
        ["all"] = "Todas",
        ["Pending"] = "A revisar",
        ["Investigating"] = "En investigación",
        ["Escalated"] = "Escaladas",
        ["Resolved"] = "Resueltas",
        ["Dismissed"] = "Descartadas"
    };
    private readonly string[] SeverityOptions = new[] { "Critical", "High", "Medium", "Low" };

    private AlertSummaryDto? summary;
    private PagedResult<SecurityAlertDto>? alerts;
    private List<UserDto> availableUsers = new();
    private SecurityAlertDto? selectedAlert;
    private SecurityAlertDetailDto? alertDetail;

    private string activeStatusTab = "all";
    private string? filterSeverity;
    private string? filterType;
    private string? filterUserId;
    private string? filterFileName;
    private string? filterDescription;
    private string? filterKeyword;
    private DateTime? filterFrom;
    private DateTime? filterTo;

    private int currentPage = 1;
    private bool isLoading = true;
    private string? error;

    private bool showReviewModal;
    private bool detailLoading;
    private bool reviewSubmitting;
    private string selectedStatusForReview = "Investigating";
    private string? reviewNotes;
    private string? reviewVerdict;
    private string? actionTaken;
    private bool blockFileAction;
    private bool blockUserAction;
    private bool escalateMonitoring;
    private bool revokeSessionsAction;
    private bool forceMfaAction;
    private bool purgeShareLinksAction;
    private bool watchlistAction;
    private bool preserveEvidenceAction;
    private bool openCaseAction;
    private bool scheduleFollowUpAction;
    private bool notifySecOpsAction;
    private int? monitoringLevel;
    private string? blockFileNotes;
    private string? blockUserNotes;
    private string? escalationNotes;
    private string? revokeSessionNotes;
    private string? forceMfaNotes;
    private string? purgeLinksNotes;
    private string? watchlistReason;
    private string? preserveEvidenceNotes;
    private string? followUpOwnerId;
    private string? followUpOwnerName;
    private string? followUpPriority;
    private DateTime? followUpDueDate;
    private string? followUpNotes;
    private string? chatMessage;
    private string? reviewError;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsersAsync();
        ParseQueryFilters();
        await LoadSummaryAsync();
        await SearchAlertsAsync();
    }

    private async Task RefreshAsync()
    {
        await LoadSummaryAsync();
        await SearchAlertsAsync();
    }

    private void ParseQueryFilters()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);
        if (query.TryGetValue("status", out var statusValue))
        {
            var normalized = NormalizeStatusKey(statusValue!);
            if (StatusTabs.ContainsKey(normalized))
            {
                activeStatusTab = normalized;
            }
        }
        if (query.TryGetValue("severity", out var severityValue))
        {
            var severity = severityValue.ToString();
            filterSeverity = SeverityOptions.Any(level => level.Equals(severity, StringComparison.OrdinalIgnoreCase))
                ? severity
                : null;
        }
    }

    private async Task LoadUsersAsync()
    {
        try
        {
            availableUsers = await Http.GetFromJsonAsync<List<UserDto>>("api/users") ?? new List<UserDto>();
            availableUsers = availableUsers
                .OrderBy(u => u.FullName)
                .ToList();
        }
        catch
        {
            availableUsers = new List<UserDto>();
        }
    }

    private async Task LoadSummaryAsync()
    {
        try
        {
            summary = await Http.GetFromJsonAsync<AlertSummaryDto>("api/aisecurity/alerts/summary");
            if (summary != null)
            {
                summary.StatusCounts = summary.StatusCounts
                    .GroupBy(pair => NormalizeStatusKey(pair.Key))
                    .ToDictionary(g => g.Key, g => g.Sum(p => p.Value), StringComparer.OrdinalIgnoreCase);
                summary.SeverityCounts = summary.SeverityCounts
                    .GroupBy(pair => string.IsNullOrWhiteSpace(pair.Key) ? "Desconocida" : pair.Key)
                    .ToDictionary(g => g.Key, g => g.Sum(p => p.Value), StringComparer.OrdinalIgnoreCase);
            }
        }
        catch (Exception ex)
        {
            error = $"No se pudo cargar el resumen de alertas: {ex.Message}";
        }
    }

    private async Task SearchAlertsAsync()
    {
        isLoading = true;
        try
        {
            var query = new Dictionary<string, string?>
            {
                ["pageNumber"] = currentPage.ToString(CultureInfo.InvariantCulture),
                ["pageSize"] = PageSize.ToString(CultureInfo.InvariantCulture),
                ["severity"] = string.IsNullOrWhiteSpace(filterSeverity) ? null : filterSeverity,
                ["status"] = activeStatusTab.Equals("all", StringComparison.OrdinalIgnoreCase) ? null : activeStatusTab,
                ["userId"] = string.IsNullOrWhiteSpace(filterUserId) ? null : filterUserId,
                ["alertType"] = string.IsNullOrWhiteSpace(filterType) ? null : filterType,
                ["fileName"] = string.IsNullOrWhiteSpace(filterFileName) ? null : filterFileName,
                ["search"] = BuildSearchTerm(),
                ["from"] = filterFrom.HasValue ? filterFrom.Value.ToString("o", CultureInfo.InvariantCulture) : null,
                ["to"] = filterTo.HasValue ? filterTo.Value.ToString("o", CultureInfo.InvariantCulture) : null
            };

            var filtered = query
                .Where(pair => !string.IsNullOrWhiteSpace(pair.Value))
                .ToDictionary(pair => pair.Key, pair => pair.Value!, StringComparer.OrdinalIgnoreCase);

            var url = QueryHelpers.AddQueryString("api/aisecurity/alerts", filtered);
            alerts = await Http.GetFromJsonAsync<PagedResult<SecurityAlertDto>>(url);
        }
        catch (Exception ex)
        {
            error = $"No se pudieron cargar las alertas: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ApplyFilters()
    {
        currentPage = 1;
        await SearchAlertsAsync();
        await LoadSummaryAsync();
    }

    private async Task ResetFilters()
    {
        filterSeverity = null;
        filterType = null;
        filterUserId = null;
        filterFileName = null;
        filterDescription = null;
        filterKeyword = null;
        filterFrom = null;
        filterTo = null;
        activeStatusTab = "all";
        await ApplyFilters();
    }

    private async Task ChangeStatusTab(string statusKey)
    {
        if (!StatusTabs.ContainsKey(statusKey))
        {
            return;
        }

        activeStatusTab = statusKey;
        currentPage = 1;
        await SearchAlertsAsync();
    }

    private async Task ChangePage(int page)
    {
        if (alerts == null || page < 1 || page > alerts.TotalPages)
        {
            return;
        }

        currentPage = page;
        await SearchAlertsAsync();
    }

    private async Task ShowReviewModal(SecurityAlertDto alert)
    {
        selectedAlert = alert;
        reviewNotes = alert.ReviewNotes ?? string.Empty;
        reviewVerdict = alert.Verdict;
        actionTaken = alert.ActionTaken ?? string.Empty;
        selectedStatusForReview = string.IsNullOrWhiteSpace(alert.Status) ? "Pending" : alert.Status;
        blockFileAction = false;
        blockUserAction = false;
        escalateMonitoring = false;
        revokeSessionsAction = false;
        forceMfaAction = false;
        purgeShareLinksAction = false;
        watchlistAction = false;
        preserveEvidenceAction = false;
        monitoringLevel = null;
        blockFileNotes = null;
        blockUserNotes = null;
        escalationNotes = null;
        revokeSessionNotes = null;
        forceMfaNotes = null;
        purgeLinksNotes = null;
        watchlistReason = null;
        preserveEvidenceNotes = null;
        chatMessage = null;
        reviewError = null;
        showReviewModal = true;
        detailLoading = true;

        try
        {
            alertDetail = await Http.GetFromJsonAsync<SecurityAlertDetailDto>($"api/aisecurity/alerts/{alert.Id}");
        }
        catch (Exception ex)
        {
            reviewError = $"No se pudo cargar el detalle de la alerta: {ex.Message}";
            alertDetail = null;
        }
        finally
        {
            detailLoading = false;
        }
    }

    private void CloseReviewModal()
    {
        showReviewModal = false;
        selectedAlert = null;
        alertDetail = null;
        reviewError = null;
        reviewSubmitting = false;
    }

    private async Task SubmitReview()
    {
        if (selectedAlert == null)
        {
            return;
        }

        reviewSubmitting = true;
        reviewError = null;

        try
        {
            var actions = BuildActionsForRequest();
            var request = new ReviewAlertRequest
            {
                AlertId = selectedAlert.Id,
                Status = selectedStatusForReview,
                ReviewNotes = reviewNotes ?? string.Empty,
                Verdict = reviewVerdict,
                ActionTaken = actionTaken ?? string.Empty,
                Actions = actions
            };

            var response = await Http.PostAsJsonAsync($"api/aisecurity/alerts/{selectedAlert.Id}/review", request);
            if (response.IsSuccessStatusCode)
            {
                await LoadSummaryAsync();
                await SearchAlertsAsync();
                CloseReviewModal();
            }
            else
            {
                var message = await response.Content.ReadAsStringAsync();
                reviewError = string.IsNullOrWhiteSpace(message) ? "No se pudo guardar la revisión." : message;
            }
        }
        catch (Exception ex)
        {
            reviewError = $"Error al guardar la revisión: {ex.Message}";
        }
        finally
        {
            reviewSubmitting = false;
        }
    }

    private async Task ExecuteQuickAction(string action)
    {
        if (selectedAlert is null || reviewSubmitting)
        {
            return;
        }

        ResetActionDeck();

        switch (action)
        {
            case "blockUser":
                blockUserAction = true;
                selectedStatusForReview = "Escalated";
                reviewVerdict = "Usuario bloqueado por actividad riesgosa";
                actionTaken = "Cuenta suspendida desde el centro de alertas";
                blockUserNotes = "Se ejecutó bloqueo inmediato";
                reviewNotes = reviewNotes ?? "Bloqueo automático desde el panel";
                break;

            case "blockFile":
                blockFileAction = true;
                selectedStatusForReview = "Escalated";
                reviewVerdict = "Archivo aislado preventivamente";
                actionTaken = "Archivo bloqueado y accesos revocados";
                blockFileNotes = "Aislamiento inmediato desde alerta";
                reviewNotes = reviewNotes ?? "Aislamiento ejecutado desde el modal";
                break;

            case "escalate":
                escalateMonitoring = true;
                monitoringLevel = (alertDetail?.Alert.EscalationLevel ?? 0) + 1;
                selectedStatusForReview = "Escalated";
                reviewVerdict = "Monitoreo reforzado activado";
                actionTaken = "Se sube nivel de seguimiento para el usuario";
                escalationNotes = "Escalamiento rápido desde panel";
                reviewNotes = reviewNotes ?? "Se incrementó el monitoreo para la cuenta";
                break;

            case "message":
                chatMessage = "Detectamos actividad inusual. ¿Puedes confirmar si reconoces esta acción?";
                selectedStatusForReview = "Investigating";
                reviewVerdict = "Contacto al usuario para aclaración";
                actionTaken = "Mensaje enviado solicitando confirmación";
                reviewNotes = reviewNotes ?? "Se abrió comunicación con la persona involucrada";
                break;

            case "resolve":
                MarkAsResolved();
                reviewNotes = reviewNotes ?? "Caso resuelto con acciones aplicadas";
                break;

            case "falsePositive":
                MarkAsFalsePositive();
                reviewNotes = reviewNotes ?? "Marcado como falso positivo después de revisión";
                break;

            case "lockdown":
                blockUserAction = !string.IsNullOrEmpty(selectedAlert?.UserId);
                blockFileAction = selectedAlert?.FileId != null;
                revokeSessionsAction = !string.IsNullOrEmpty(selectedAlert?.UserId);
                forceMfaAction = !string.IsNullOrEmpty(selectedAlert?.UserId);
                purgeShareLinksAction = selectedAlert?.FileId != null;
                selectedStatusForReview = "Escalated";
                reviewVerdict = "Modo contención activado";
                actionTaken = "Bloqueo inmediato + purga de sesiones y enlaces";
                blockUserNotes = "Cuenta bloqueada y sesiones revocadas desde el dashboard";
                blockFileNotes = "Archivo aislado y enlaces eliminados";
                revokeSessionNotes = "Revocación forzada por incidente crítico";
                purgeLinksNotes = "Purgado automático por riesgo de exfiltración";
                forceMfaNotes = "Se requiere MFA y reset tras contención";
                reviewNotes = reviewNotes ?? "Se ejecutó contención total para evitar propagación";
                break;
        }

        await SubmitReview();
    }

    private List<AlertActionCommand> BuildActionsForRequest()
    {
        var actions = new List<AlertActionCommand>();
        if (blockFileAction && (selectedAlert?.FileId != null || alertDetail?.Alert.FileId != null))
        {
            actions.Add(new AlertActionCommand
            {
                ActionType = "BlockFile",
                TargetFileId = selectedAlert?.FileId ?? alertDetail?.Alert.FileId,
                Notes = blockFileNotes
            });
        }

        if (blockUserAction && !string.IsNullOrEmpty(selectedAlert?.UserId))
        {
            actions.Add(new AlertActionCommand
            {
                ActionType = "BlockUser",
                TargetUserId = selectedAlert?.UserId,
                Notes = blockUserNotes
            });
        }

        if (escalateMonitoring && !string.IsNullOrEmpty(selectedAlert?.UserId))
        {
            var level = monitoringLevel ?? ((alertDetail?.Alert.EscalationLevel ?? 0) + 1);
            actions.Add(new AlertActionCommand
            {
                ActionType = "IncreaseMonitoring",
                TargetUserId = selectedAlert?.UserId,
                MonitoringLevel = level,
                Notes = escalationNotes
            });
        }

        if (revokeSessionsAction && !string.IsNullOrEmpty(selectedAlert?.UserId))
        {
            actions.Add(new AlertActionCommand
            {
                ActionType = "RevokeSessions",
                TargetUserId = selectedAlert?.UserId,
                Notes = revokeSessionNotes
            });
        }

        if (forceMfaAction && !string.IsNullOrEmpty(selectedAlert?.UserId))
        {
            actions.Add(new AlertActionCommand
            {
                ActionType = "ForceMfaReset",
                TargetUserId = selectedAlert?.UserId,
                Notes = forceMfaNotes
            });
        }

        if (purgeShareLinksAction && (selectedAlert?.FileId != null || alertDetail?.Alert.FileId != null))
        {
            actions.Add(new AlertActionCommand
            {
                ActionType = "PurgeShareLinks",
                TargetFileId = selectedAlert?.FileId ?? alertDetail?.Alert.FileId,
                Notes = purgeLinksNotes
            });
        }

        if (watchlistAction && !string.IsNullOrEmpty(selectedAlert?.UserId))
        {
            actions.Add(new AlertActionCommand
            {
                ActionType = "AddToWatchlist",
                TargetUserId = selectedAlert?.UserId,
                Notes = watchlistReason
            });
        }

        if (preserveEvidenceAction)
        {
            actions.Add(new AlertActionCommand
            {
                ActionType = "PreserveEvidence",
                TargetFileId = selectedAlert?.FileId ?? alertDetail?.Alert.FileId,
                TargetUserId = selectedAlert?.UserId,
                Notes = preserveEvidenceNotes
            });
        }

        if (openCaseAction)
        {
            var metadata = JsonSerializer.Serialize(new
            {
                ownerId = followUpOwnerId,
                owner = followUpOwnerName,
                priority = followUpPriority,
                due = followUpDueDate?.ToString("o", CultureInfo.InvariantCulture),
                notify = notifySecOpsAction
            });

            actions.Add(new AlertActionCommand
            {
                ActionType = "OpenCase",
                TargetFileId = selectedAlert?.FileId ?? alertDetail?.Alert.FileId,
                TargetUserId = selectedAlert?.UserId,
                Notes = followUpNotes ?? actionTaken ?? "Caso abierto desde el centro de alertas",
                Metadata = metadata
            });
        }

        if (scheduleFollowUpAction)
        {
            var metadata = JsonSerializer.Serialize(new
            {
                due = followUpDueDate?.ToString("o", CultureInfo.InvariantCulture),
                priority = followUpPriority,
                notify = notifySecOpsAction,
                ownerId = followUpOwnerId,
                owner = followUpOwnerName
            });

            actions.Add(new AlertActionCommand
            {
                ActionType = "ScheduleFollowUp",
                TargetFileId = selectedAlert?.FileId ?? alertDetail?.Alert.FileId,
                TargetUserId = selectedAlert?.UserId,
                Notes = followUpNotes ?? "Seguimiento programado",
                Metadata = metadata
            });
        }

        if (!string.IsNullOrWhiteSpace(chatMessage) && !string.IsNullOrEmpty(selectedAlert?.UserId))
        {
            actions.Add(new AlertActionCommand
            {
                ActionType = "Message",
                TargetUserId = selectedAlert?.UserId,
                Notes = chatMessage,
                Metadata = "{\"channel\":\"internal\"}"
            });
        }

        return actions;
    }

    private string? BuildSearchTerm()
    {
        var combined = string.Join(" ", new[] { filterKeyword, filterDescription }
            .Where(term => !string.IsNullOrWhiteSpace(term))
            .Select(term => term!.Trim()));

        return string.IsNullOrWhiteSpace(combined) ? null : combined;
    }

    private void TriggerActionBlockUser()
    {
        blockUserAction = !blockUserAction;
        if (blockUserAction)
        {
            selectedStatusForReview = "Escalated";
            reviewVerdict ??= "Usuario bloqueado preventivamente";
            actionTaken ??= "Cuenta suspendida mientras se investiga";
            blockUserNotes ??= "Bloqueo inmediato desde el centro de alertas";
        }
    }

    private void TriggerActionBlockFile()
    {
        blockFileAction = !blockFileAction;
        if (blockFileAction)
        {
            reviewVerdict ??= "Archivo aislado";
            actionTaken ??= "Archivo bloqueado y acceso revocado";
            blockFileNotes ??= "Se aísla el archivo sospechoso";
        }
    }

    private void TriggerActionEscalate()
    {
        escalateMonitoring = !escalateMonitoring;
        if (escalateMonitoring)
        {
            selectedStatusForReview = "Escalated";
            monitoringLevel ??= (alertDetail?.Alert.EscalationLevel ?? 0) + 1;
            escalationNotes ??= "Seguimiento reforzado activado";
            reviewVerdict ??= "Escalado a monitoreo reforzado";
        }
    }

    private void TriggerRevokeSessions()
    {
        revokeSessionsAction = !revokeSessionsAction;
        if (revokeSessionsAction)
        {
            actionTaken ??= "Sesiones revocadas y tokens invalidados";
            revokeSessionNotes ??= "Cierre forzado por actividad sospechosa";
        }
    }

    private void TriggerForceMfa()
    {
        forceMfaAction = !forceMfaAction;
        if (forceMfaAction)
        {
            actionTaken ??= "Se exige MFA y restablecimiento de contraseña";
            forceMfaNotes ??= "Reautenticación requerida tras alerta";
            selectedStatusForReview = "Escalated";
        }
    }

    private void TriggerPurgeLinks()
    {
        purgeShareLinksAction = !purgeShareLinksAction;
        if (purgeShareLinksAction)
        {
            actionTaken ??= "Enlaces compartidos eliminados";
            purgeLinksNotes ??= "Se revocaron enlaces públicos y compartidos";
        }
    }

    private void TriggerWatchlist()
    {
        watchlistAction = !watchlistAction;
        if (watchlistAction)
        {
            selectedStatusForReview = "Investigating";
            watchlistReason ??= "Observación reforzada por patrón de riesgo";
        }
    }

    private void TriggerPreserveEvidence()
    {
        preserveEvidenceAction = !preserveEvidenceAction;
        if (preserveEvidenceAction)
        {
            preserveEvidenceNotes ??= "Retener logs, snapshots y accesos relacionados";
            actionTaken ??= "Cadena de custodia activada";
        }
    }

    private void PresetMessage()
    {
        if (string.IsNullOrWhiteSpace(chatMessage))
        {
            chatMessage = "Detectamos actividad inusual. ¿Puedes confirmar si reconoces esta acción?";
        }

        actionTaken ??= "Se solicitó aclaración al usuario";
    }

    private void ToggleCaseAction()
    {
        openCaseAction = !openCaseAction;
        if (openCaseAction)
        {
            selectedStatusForReview = "Investigating";
            reviewVerdict ??= "Caso abierto y asignado";
            actionTaken ??= "Caso creado en mesa de tickets";
            followUpNotes ??= "Se abre caso interno desde el centro de alertas";
            followUpDueDate ??= DateTime.UtcNow.AddDays(1);
        }
    }

    private void ToggleFollowUp()
    {
        scheduleFollowUpAction = !scheduleFollowUpAction;
        if (scheduleFollowUpAction)
        {
            followUpDueDate ??= DateTime.UtcNow.AddHours(8);
            followUpPriority ??= "Alta";
            selectedStatusForReview = "Investigating";
            actionTaken ??= "Seguimiento calendarizado";
        }
    }

    private void TriggerCaseworkPreset()
    {
        ResetActionDeck();
        openCaseAction = true;
        scheduleFollowUpAction = true;
        notifySecOpsAction = true;
        followUpPriority = "Alta";
        followUpDueDate = DateTime.UtcNow.AddHours(4);
        followUpNotes = "Caso formal abierto con SLA acelerado y notificación a SecOps.";
        reviewVerdict = "Caso en gestión activa";
        selectedStatusForReview = "Investigating";
        actionTaken = "Ticket creado, propietario asignado, SLA en curso";
        reviewNotes = "Se abre ticket interno para seguimiento coordinado.";
    }

    private void MarkAsFalsePositive()
    {
        blockUserAction = false;
        blockFileAction = false;
        escalateMonitoring = false;
        revokeSessionsAction = false;
        forceMfaAction = false;
        purgeShareLinksAction = false;
        watchlistAction = false;
        preserveEvidenceAction = false;
        openCaseAction = false;
        scheduleFollowUpAction = false;
        notifySecOpsAction = false;
        selectedStatusForReview = "Dismissed";
        reviewVerdict = "Falso positivo confirmado";
        actionTaken = "Se documenta como excepción aprobada";
    }

    private void MarkAsResolved()
    {
        selectedStatusForReview = "Resolved";
        reviewVerdict ??= "Resuelto con acciones correctivas";
        actionTaken = string.IsNullOrWhiteSpace(actionTaken)
            ? "Caso resuelto y monitoreo continuo"
            : actionTaken;
    }

    private void ResetActionDeck()
    {
        blockFileAction = false;
        blockUserAction = false;
        escalateMonitoring = false;
        revokeSessionsAction = false;
        forceMfaAction = false;
        purgeShareLinksAction = false;
        watchlistAction = false;
        preserveEvidenceAction = false;
        openCaseAction = false;
        scheduleFollowUpAction = false;
        notifySecOpsAction = false;
        monitoringLevel = null;
        blockFileNotes = null;
        blockUserNotes = null;
        escalationNotes = null;
        revokeSessionNotes = null;
        forceMfaNotes = null;
        purgeLinksNotes = null;
        watchlistReason = null;
        preserveEvidenceNotes = null;
        followUpOwnerId = null;
        followUpOwnerName = null;
        followUpPriority = null;
        followUpDueDate = null;
        followUpNotes = null;
        chatMessage = null;
        selectedStatusForReview = string.IsNullOrWhiteSpace(selectedAlert?.Status) ? "Pending" : NormalizeStatusKey(selectedAlert?.Status);
        reviewVerdict = selectedAlert?.Verdict;
        actionTaken = selectedAlert?.ActionTaken ?? string.Empty;
    }

    private string RenderStatusBadge(string? status)
    {
        status = NormalizeStatusKey(status);
        return status switch
        {
            "Resolved" => @"<span class=""badge bg-success"">Resuelta</span>",
            "Dismissed" => @"<span class=""badge bg-secondary"">Descartada</span>",
            "Investigating" => @"<span class=""badge bg-warning text-dark"">En investigación</span>",
            "Escalated" => @"<span class=""badge bg-danger"">Escalada</span>",
            "Pending" or _ => @"<span class=""badge bg-primary"">A revisar</span>"
        };
    }

    private MarkupString RenderStatusBadgeMarkup(string? status) => new MarkupString(RenderStatusBadge(status));

    private int GetStatusCount(string statusKey)
    {
        if (summary?.StatusCounts == null)
        {
            return 0;
        }

        if (statusKey.Equals("all", StringComparison.OrdinalIgnoreCase))
        {
            return summary.StatusCounts.Values.Sum();
        }

        summary.StatusCounts.TryGetValue(statusKey, out var count);
        return count;
    }

    private string GetSeverityColor(string? severity) => severity switch
    {
        "Critical" => "danger",
        "High" => "warning",
        "Medium" => "info",
        "Low" => "secondary",
        _ => "secondary"
    };

    private static string NormalizeStatusKey(string? raw)
    {
        if (string.IsNullOrWhiteSpace(raw))
        {
            return "Pending";
        }

        return raw.Trim().ToLowerInvariant() switch
        {
            "pending" or "pendiente" => "Pending",
            "investigating" or "investigacion" or "investigando" => "Investigating",
            "escalated" or "escalada" => "Escalated",
            "resolved" or "resuelta" or "solved" => "Resolved",
            "dismissed" or "descartada" or "closed" => "Dismissed",
            _ => CultureInfo.InvariantCulture.TextInfo.ToTitleCase(raw.Trim().ToLowerInvariant())
        };
    }

    private static int SeverityOrder(string severity) => severity switch
    {
        "Critical" => 4,
        "High" => 3,
        "Medium" => 2,
        "Low" => 1,
        _ => 0
    };
}
