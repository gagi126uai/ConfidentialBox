@page "/ai-security"
@using System
@using System.Collections.Generic
@using System.Globalization
@using ConfidentialBox.Core.DTOs
@using ConfidentialBox.Web.Services
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Rendering
@using ConfidentialBox.Core.Entities
@attribute [Authorize(Roles = "Admin")]
@inject HttpClient Http
@inject ISettingsService SettingsService

<PageTitle>AI Security Dashboard - ConfidentialBox</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1 class="mb-0"><i class="fas fa-brain"></i> AI Security Dashboard</h1>
        <p class="text-muted small mb-0">Monitoreo en tiempo real y ajustes del motor de IA.</p>
    </div>
    <button class="btn btn-primary" @onclick="RunFullScan" disabled="@scanRunning">
        @if (scanRunning)
        {
            <span class="spinner-border spinner-border-sm me-2">Escaneando…</span>
            
        }
        else
        {
            <span><i class="fas fa-search"></i> Escanear sistema</span>
        }
    </button>
</div>

@if (!string.IsNullOrEmpty(scanMessage))
{
    <div class="alert @(scanSuccess ? "alert-success" : "alert-danger")">@scanMessage</div>
}

@if (lastScan is not null)
{
    <div class="alert alert-info d-flex justify-content-between align-items-center">
        <div>
            <strong>Último escaneo:</strong> @lastScan.ExecutedAtUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss")
            <span class="ms-2">Alertas nuevas: @lastScan.AlertsGenerated</span>
            <span class="ms-2">Perfiles de alto riesgo: @lastScan.HighRiskProfilesReviewed</span>
        </div>
        <span class="text-muted">@lastScan.Message</span>
    </div>
}

<div class="card shadow-sm">
    <div class="card-header bg-white border-bottom">
        <ul class="nav nav-tabs card-header-tabs flex-nowrap overflow-auto pb-1">
            <li class="nav-item">
                <button type="button"
                        class="nav-link @(activeTab == "overview" ? "active" : string.Empty)"
                        @onclick='() => SetActiveTab("overview")'>
                    <i class="fas fa-chart-line"></i> Resumen
                </button>
            </li>
            <li class="nav-item">
                <button type="button"
                        class="nav-link @(activeTab == "alerts" ? "active" : string.Empty)"
                        @onclick='() => SetActiveTab("alerts")'>
                    <i class="fas fa-bell"></i> Centro de alertas
                    @if ((alertSummary?.NewAlerts ?? 0) > 0)
                    {
                        <span class="badge rounded-pill text-bg-danger ms-2">@alertSummary!.NewAlerts</span>
                    }
                </button>
            </li>
            <li class="nav-item">
                <button type="button"
                        class="nav-link @(activeTab == "settings" ? "active" : string.Empty)"
                        @onclick='() => SetActiveTab("settings")'>
                    <i class="fas fa-sliders-h"></i> Configuración de IA
                </button>
            </li>
        </ul>
    </div>
    <div class="card-body">
        @if (activeTab == "overview")
        {
            if (isLoading)
            {
                <div class="text-center my-5">
                    <div class="spinner-border" role="status"></div>
                    <p class="mt-3 text-muted">Analizando sistema con IA…</p>
                </div>
            }
            else if (dashboard is null)
            {
                <div class="alert alert-danger mb-0">No fue posible cargar los datos del tablero de IA.</div>
            }
            else
            {
                var statCards = new[]
                {
                new { Color = "danger",  Title = "Alertas Críticas",     Value = dashboard.CriticalAlertsUnreviewed.ToString(),  Subtitle = "Sin revisar",        Icon = "fas fa-exclamation-triangle" },
                new { Color = "warning", Title = "Usuarios Alto Riesgo", Value = dashboard.HighRiskUsers.ToString(),           Subtitle = "Requieren atención", Icon = "fas fa-user-shield" },
                new { Color = "info",    Title = "Archivos Sospechosos", Value = dashboard.SuspiciousFilesDetected.ToString(), Subtitle = "Detectados hoy",    Icon = "fas fa-file-medical-alt" },
                new { Color = "primary", Title = "Alertas Hoy",          Value = dashboard.TotalAlertsToday.ToString(),       Subtitle = "Total del día",     Icon = "fas fa-bell" }
                };

                <div class="row g-3 mb-4">
                    @foreach (var card in statCards)
                    {
                        <div class="col-sm-6 col-lg-3">
                            <div class="card text-white bg-@card.Color h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="text-uppercase small fw-bold">@card.Title</h6>
                                            <h2 class="fw-bold">@card.Value</h2>
                                            <small>@card.Subtitle</small>
                                        </div>
                                        <i class="@card.Icon fa-2x opacity-50"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                var statusSource = alertSummary?.StatusCounts ?? new Dictionary<string, int>();
                var statusTotal = statusSource.Values.Sum();
                var orderedStatus = statusSource
                    .OrderByDescending(pair => pair.Value)
                    .ThenBy(pair => pair.Key)
                    .ToList();

                <div class="row g-4 mb-4">
                    <div class="col-xl-5">
                        <div class="card h-100 shadow-sm">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Embudo de respuesta</h5>
                                <span class="badge text-bg-secondary">@statusTotal casos</span>
                            </div>
                            <div class="card-body">
                                @if (!orderedStatus.Any())
                                {
                                    <p class="text-muted mb-0">Sin incidentes pendientes. La IA mantiene la vigilancia.</p>
                                }
                                else
                                {
                                    <ul class="list-unstyled mb-0 small d-flex flex-column gap-3">
                                        @foreach (var status in orderedStatus)
                                        {
                                            var percentage = statusTotal == 0 ? 0 : (int)Math.Round((status.Value / (double)statusTotal) * 100);
                                            <li>
                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                    <strong>@status.Key</strong>
                                                    <span class="badge text-bg-primary">@status.Value</span>
                                                </div>
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar bg-primary" style="@($"width: {percentage}%")"></div>
                                                </div>
                                                <span class="text-muted">@percentage% de los casos activos</span>
                                            </li>
                                        }
                                    </ul>
                                }
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-7">
                        <div class="card h-100 shadow-sm">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Prioridades inmediatas</h5>
                                <span class="badge text-bg-info"><i class="fas fa-robot me-1"></i>IA</span>
                            </div>
                            <div class="card-body">
                                @if (dashboard.ActionRecommendations?.Any() == true)
                                {
                                    <ol class="mb-0 small ps-3">
                                        @foreach (var recommendation in dashboard.ActionRecommendations.Take(5))
                                        {
                                            <li class="mb-2">
                                                <strong>@recommendation</strong>
                                            </li>
                                        }
                                    </ol>
                                    if (dashboard.ActionRecommendations.Count > 5)
                                    {
                                        <p class="text-muted small mb-0">La vista completa se encuentra en el centro de alertas.</p>
                                    }
                                }
                                else
                                {
                                    <p class="text-muted mb-0">Sin acciones urgentes. Se mantiene monitoreo preventivo.</p>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">Alertas por Tipo</h5>
                            </div>
                            <div class="card-body">
                                @if (dashboard.AlertsByType is null || !dashboard.AlertsByType.Any())
                                {
                                    <p class="text-muted text-center mb-0">No hay datos disponibles</p>
                                }
                                else
                                {
                                    var max = dashboard.AlertsByType.Values.Max();
                                    <div class="table-responsive">
                                        <table class="table table-sm align-middle mb-0">
                                            <tbody>
                                                @foreach (var item in dashboard.AlertsByType.OrderByDescending(a => a.Value))
                                                {
                                                    var percentage = GetPercentage(item.Value, max);
                                                    <tr>
                                                        <td class="fw-semibold">@item.Key</td>
                                                        <td>
                                                            <div class="progress" style="height: 20px;">
                                                                <div class="progress-bar" style="@($"width: {percentage:F0}%")">
                                                                    @item.Value
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">Tendencia de Amenazas (7 días)</h5>
                            </div>
                            <div class="card-body">
                                @if (dashboard.ThreatTrends is null || !dashboard.ThreatTrends.Any())
                                {
                                    <p class="text-muted text-center mb-0">No hay datos disponibles</p>
                                }
                                else
                                {
                                    var max = dashboard.ThreatTrends.Values.Any()
                                    ? dashboard.ThreatTrends.Values.Max()
                                    : 0;

                                    var safeMax = max == 0 ? 1 : max;

                                    <div class="table-responsive">
                                        <table class="table table-sm align-middle mb-0">
                                            <tbody>
                                                @foreach (var item in dashboard.ThreatTrends.OrderBy(t => t.Key))
                                                {
                                                    var percentage = GetPercentage(item.Value, safeMax);
                                                    <tr>
                                                        <td class="fw-semibold">@item.Key</td>
                                                        <td>
                                                            <div class="progress" style="height: 20px;">
                                                                <div class="progress-bar bg-info" style="@($"width: {percentage:F0}%")">
                                                                    @item.Value
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body text-center py-5 text-muted">
                        <i class="fas fa-chart-pie fa-2x mb-3"></i>
                        <p class="mb-0">Explora el centro de alertas para obtener detalles accionables y priorizar la respuesta.</p>
                        <button class="btn btn-outline-primary btn-sm mt-3" @onclick='() => SetActiveTab("alerts")'>
                            Ir al centro de alertas
                        </button>
                    </div>
                </div>
            }
        }
        else if (activeTab == "alerts")
        {
            <div class="row g-4">
                <div class="col-xl-4">
                    <div class="card h-100 shadow-sm border-0">
                        <div class="card-body d-flex flex-column gap-3">
                            <div>
                                <h5 class="card-title d-flex align-items-center gap-2 mb-2">
                                    <i class="fas fa-signal"></i>
                                    Salud del sistema
                                </h5>
                                <ul class="list-unstyled mb-0 small">
                                    <li class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Alertas nuevas hoy</span>
                                        <span class="badge text-bg-primary">@((alertSummary?.NewAlerts ?? 0).ToString())</span>
                                    </li>
                                    <li class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Críticas sin revisar</span>
                                        <span class="badge text-bg-danger">@((dashboard?.CriticalAlertsUnreviewed ?? 0).ToString())</span>
                                    </li>
                                    <li class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Usuarios de alto riesgo</span>
                                        <span class="badge text-bg-warning text-dark">@((dashboard?.HighRiskUsers ?? 0).ToString())</span>
                                    </li>
                                    <li class="d-flex justify-content-between align-items-center">
                                        <span>Archivos sospechosos</span>
                                        <span class="badge text-bg-info">@((dashboard?.SuspiciousFilesDetected ?? 0).ToString())</span>
                                    </li>
                                </ul>
                            </div>

                            @if (alertSummary?.SeverityCounts?.Any() == true)
                            {
                                <div>
                                    <h6 class="text-muted text-uppercase small">Distribución por severidad</h6>
                                    <div class="d-flex flex-column gap-2">
                                        @foreach (var severity in alertSummary.SeverityCounts.OrderByDescending(pair => pair.Value))
                                        {
                                            <div class="d-flex align-items-center gap-2">
                                                <span class="badge bg-@GetSeverityColor(severity.Key)">@severity.Key</span>
                                                <div class="flex-grow-1">
                                                    <div class="progress" style="height: 8px;">
                                                        <div class="progress-bar bg-@GetSeverityColor(severity.Key)" style="@($"width: {GetSeverityPercentage(severity.Value, alertSummary.SeverityCounts.Values.Sum()):F0}%")"></div>
                                                    </div>
                                                </div>
                                                <span class="fw-semibold">@severity.Value</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }

                            <div>
                                <h6 class="text-muted text-uppercase small">Acciones recomendadas</h6>
                                @if (dashboard?.ActionRecommendations?.Any() == true)
                                {
                                    <ul class="list-group list-group-flush small">
                                        @foreach (var recommendation in dashboard.ActionRecommendations)
                                        {
                                            <li class="list-group-item px-0">
                                                <i class="fas fa-check-circle text-success me-2"></i>@recommendation
                                            </li>
                                        }
                                    </ul>
                                }
                                else
                                {
                                    <p class="text-muted small mb-0">Sin acciones urgentes. El monitoreo continúa estable.</p>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-8">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-white d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-2">
                            <div>
                                <h5 class="mb-0">Centro de alertas</h5>
                                <small class="text-muted">Eventos priorizados por la IA</small>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            @if (dashboard?.RecentAlerts is null || !dashboard.RecentAlerts.Any())
                            {
                                <div class="alert alert-success m-3">
                                    <i class="fas fa-check-circle me-1"></i>No hay eventos sospechosos en este momento.
                                </div>
                            }
                            else
                            {
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Tipo</th>
                                                <th>Severidad</th>
                                                <th>Usuario</th>
                                                <th>Archivo</th>
                                                <th>Confianza</th>
                                                <th>Detectada</th>
                                                <th>Estado</th>
                                                <th class="text-end">Detalle</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var alert in dashboard.RecentAlerts.Take(12))
                                            {
                                                <tr>
                                                    <td>@alert.AlertType</td>
                                                    <td><span class="badge bg-@GetSeverityColor(alert.Severity)">@alert.Severity</span></td>
                                                    <td>@(string.IsNullOrWhiteSpace(alert.UserName) ? "Usuario desconocido" : alert.UserName)</td>
                                                    <td>@(string.IsNullOrWhiteSpace(alert.FileName) ? "-" : alert.FileName)</td>
                                                    <td>@($"{alert.ConfidenceScore * 100:F0}%")</td>
                                                    <td>@alert.DetectedAt.ToLocalTime().ToString("dd/MM HH:mm")</td>
                                                    <td>
                                                        <span class="badge bg-@(alert.IsReviewed ? "success" : "warning text-dark")">
                                                            @(alert.IsReviewed ? "Revisada" : "Pendiente")
                                                        </span>
                                                    </td>
                                                    <td class="text-end">
                                                        <button class="btn btn-sm btn-outline-primary" @onclick="async () => await OpenAlertDetailAsync(alert)">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0">Perfiles de mayor riesgo</h5>
                                <small class="text-muted">Usuarios que requieren seguimiento inmediato</small>
                            </div>
                        </div>
                        <div class="card-body">
                            @if (dashboard?.HighRiskUsersDetails?.Any() == true)
                            {
                                <div class="table-responsive">
                                    <table class="table align-middle">
                                        <thead>
                                            <tr>
                                                <th>Usuario</th>
                                                <th>Riesgo</th>
                                                <th>Promedio diarios</th>
                                                <th>Hoy</th>
                                                <th>Hallazgos</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var user in dashboard.HighRiskUsersDetails)
                                            {
                                                <tr>
                                                    <td>@user.UserName</td>
                                                    <td>
                                                        <div class="d-flex align-items-center gap-2">
                                                            <span class="badge bg-@GetThreatLevelColor(user.RiskScore)">@GetThreatLevelText(user.RiskScore)</span>
                                                            <span class="small text-muted">@($"{user.RiskScore * 100:F0}%")</span>
                                                        </div>
                                                    </td>
                                                    <td>@user.AverageFilesPerDay:F1</td>
                                                    <td>@user.CurrentFilesPerDay</td>
                                                    <td>
                                                        @if (user.AnomaliesDetected?.Any() == true)
                                                        {
                                                            <ul class="list-unstyled mb-0 small">
                                                                @foreach (var insight in user.AnomaliesDetected)
                                                                {
                                                                    <li><i class="fas fa-exclamation-triangle text-warning me-1"></i>@insight</li>
                                                                }
                                                            </ul>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted small">Sin hallazgos recientes.</span>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-info-circle me-1"></i>No hay usuarios catalogados como alto riesgo.
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            if (aiSettingsLoading)
            {
                <div class="text-center my-5">
                    <div class="spinner-border" role="status"></div>
                    <p class="mt-3 text-muted">Cargando parámetros de IA…</p>
                </div>
            }
            else
            {
                <EditForm Model="aiSettings" OnValidSubmit="SaveAIScoringAsync">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    @if (!string.IsNullOrEmpty(aiMessage))
                    {
                        <div class="alert @(aiSuccess ? "alert-success" : "alert-danger")">@aiMessage</div>
                    }

                    <div class="row g-4">
                        <div class="col-lg-4">
                            <h6 class="text-muted text-uppercase">Umbrales generales</h6>
                            <InputNumberField Label="Umbral riesgo alto" @bind-Value="aiSettings.HighRiskThreshold" />
                            <InputNumberField Label="Umbral sospechoso" @bind-Value="aiSettings.SuspiciousThreshold" />
                            <InputNumberField Label="Recomendación: Bloquear" @bind-Value="aiSettings.RecommendationBlockThreshold" />
                            <InputNumberField Label="Recomendación: Revisar" @bind-Value="aiSettings.RecommendationReviewThreshold" />
                            <InputNumberField Label="Recomendación: Monitorear" @bind-Value="aiSettings.RecommendationMonitorThreshold" />
                            <InputNumberField Label="Riesgo Alto (usuarios)" @bind-Value="aiSettings.RiskLevelHighThreshold" />
                            <InputNumberField Label="Riesgo Medio (usuarios)" @bind-Value="aiSettings.RiskLevelMediumThreshold" />
                        </div>
                        <div class="col-lg-4">
                            <h6 class="text-muted text-uppercase">Puntajes de archivo</h6>
                            <InputNumberField Label="Puntos extensión sospechosa" @bind-Value="aiSettings.SuspiciousExtensionScore" />
                            <InputNumberField Label="Puntos archivo grande" @bind-Value="aiSettings.LargeFileScore" />
                            <InputNumberField Label="Puntos fuera de horario" @bind-Value="aiSettings.OutsideBusinessHoursScore" />
                            <InputNumberField Label="Puntos carga inusual" @bind-Value="aiSettings.UnusualUploadsScore" />
                            <InputNumberField Label="Puntos tamaño inusual" @bind-Value="aiSettings.UnusualFileSizeScore" />
                            <InputNumberField Label="Puntos acceso fuera de horario" @bind-Value="aiSettings.OutsideHoursBehaviorScore" />
                            <InputNumberField Label="Incremento por actividad inusual" @bind-Value="aiSettings.UnusualActivityIncrement" />
                            <InputNumberField Label="Peso prob. malware" @bind-Value="aiSettings.MalwareProbabilityWeight" />
                            <InputNumberField Label="Peso prob. exfiltración" @bind-Value="aiSettings.DataExfiltrationWeight" />
                        </div>
                        <div class="col-lg-4">
                            <h6 class="text-muted text-uppercase">Comportamiento y límites</h6>
                            <InputNumberField Label="Hora inicio" @bind-Value="aiSettings.BusinessHoursStart" />
                            <InputNumberField Label="Hora fin" @bind-Value="aiSettings.BusinessHoursEnd" />
                            <InputNumberField Label="Multiplicador carga inusual" @bind-Value="aiSettings.UploadAnomalyMultiplier" />
                            <InputNumberField Label="Multiplicador tamaño inusual" @bind-Value="aiSettings.FileSizeAnomalyMultiplier" />
                            <InputNumberField Label="Tamaño máximo evaluado (MB)" @bind-Value="aiSettings.MaxFileSizeMB" />

                            <h6 class="text-muted text-uppercase mt-4">Pesos avanzados</h6>
                            <InputNumberField Label="Peso extensión peligrosa" @bind-Value="aiSettings.MalwareSuspiciousExtensionWeight" />
                            <InputNumberField Label="Peso palabra 'crack'" @bind-Value="aiSettings.MalwareCrackKeywordWeight" />
                            <InputNumberField Label="Peso palabra 'keygen'" @bind-Value="aiSettings.MalwareKeygenKeywordWeight" />
                            <InputNumberField Label="Peso ejecutables" @bind-Value="aiSettings.MalwareExecutableWeight" />
                            <InputNumberField Label="Umbral archivo grande (MB)" @bind-Value="aiSettings.DataExfiltrationLargeFileMB" />
                            <InputNumberField Label="Umbral archivo muy grande (MB)" @bind-Value="aiSettings.DataExfiltrationHugeFileMB" />
                            <InputNumberField Label="Peso archivo grande" @bind-Value="aiSettings.DataExfiltrationLargeFileWeight" />
                            <InputNumberField Label="Peso archivo muy grande" @bind-Value="aiSettings.DataExfiltrationHugeFileWeight" />
                            <InputNumberField Label="Peso archivos comprimidos" @bind-Value="aiSettings.DataExfiltrationArchiveWeight" />
                            <InputNumberField Label="Peso actividad fuera de horario" @bind-Value="aiSettings.DataExfiltrationOffHoursWeight" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Extensiones sospechosas (separar por coma)</label>
                        <InputTextArea class="form-control" @bind-Value="aiSettings.SuspiciousExtensions" Rows="3" />
                    </div>

                    <button type="submit" class="btn btn-primary" disabled="@aiSaving">
                        @if (aiSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-2">Guardando IA…</span>
                        }
                        else
                        {
                            <span>Guardar configuración avanzada</span>
                        }
                    </button>
                </EditForm>
            }
        }
    </div>
</div>

@if (showAlertDetail && selectedAlert is not null)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalle de alerta @selectedAlert.Id</h5>
                    <button type="button" class="btn-close" @onclick="CloseAlertDetail"></button>
                </div>
                <div class="modal-body">
                    @if (alertDetailLoading)
                    {
                        <div class="text-center py-4">
                            <div class="spinner-border" role="status"></div>
                            <p class="mt-3 text-muted">Recopilando evidencia del evento…</p>
                        </div>
                    }
                    else
                    {
                        if (!string.IsNullOrEmpty(alertDetailError))
                        {
                            <div class="alert alert-danger">@alertDetailError</div>
                        }

                        var detailAlert = selectedAlertDetail?.Alert ?? selectedAlert;
                        if (detailAlert is not null)
                        {
                            <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
                                <span class="badge bg-@GetSeverityColor(detailAlert.Severity)">@detailAlert.Severity</span>
                                <span class="badge bg-secondary">@detailAlert.AlertType</span>
                                <span class="badge bg-light text-dark"><i class="fas fa-bolt me-1"></i>@FormatAlertStatus(detailAlert)</span>
                            </div>
                            <dl class="row mb-0">
                                <dt class="col-sm-4">Usuario</dt>
                                <dd class="col-sm-8">@(string.IsNullOrWhiteSpace(detailAlert.UserName) ? "Usuario desconocido" : detailAlert.UserName)</dd>
                                <dt class="col-sm-4">Archivo</dt>
                                <dd class="col-sm-8">@(string.IsNullOrWhiteSpace(detailAlert.FileName) ? "-" : detailAlert.FileName)</dd>
                                <dt class="col-sm-4">Confianza</dt>
                                <dd class="col-sm-8">@FormatConfidence(detailAlert.ConfidenceScore)</dd>
                                <dt class="col-sm-4">Detectada</dt>
                                <dd class="col-sm-8">@FormatAlertDate(detailAlert.DetectedAt)</dd>
                                <dt class="col-sm-4">Escalamiento</dt>
                                <dd class="col-sm-8">@GetEscalationLabel(detailAlert.EscalationLevel)</dd>
                            </dl>

                            <div class="mt-3">
                                <h6>Descripción</h6>
                                <p class="mb-0">@detailAlert.Description</p>
                            </div>

                            @if (!string.IsNullOrWhiteSpace(detailAlert.ReviewNotes))
                            {
                                <div class="mt-3">
                                    <h6>Notas de revisión</h6>
                                    <p class="mb-0">@detailAlert.ReviewNotes</p>
                                </div>
                            }

                            @if (!string.IsNullOrWhiteSpace(detailAlert.ActionTaken))
                            {
                                <div class="mt-3">
                                    <h6>Acción aplicada</h6>
                                    <p class="mb-0">@detailAlert.ActionTaken</p>
                                </div>
                            }
                        }

                        if (selectedAlertDetail is not null)
                        {
                            <div class="mt-4">
                                <h6 class="text-muted text-uppercase small">Capacidades disponibles</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    <span class="badge text-bg-@(selectedAlertDetail.CanBlockFile ? "danger" : "secondary")"><i class="fas fa-file-shield me-1"></i>Bloquear archivo @(selectedAlertDetail.CanBlockFile ? "habilitado" : "no disponible")</span>
                                    <span class="badge text-bg-@(selectedAlertDetail.CanBlockUser ? "warning text-dark" : "secondary")"><i class="fas fa-user-lock me-1"></i>Suspender usuario @(selectedAlertDetail.CanBlockUser ? "habilitado" : "no disponible")</span>
                                    <span class="badge text-bg-@(selectedAlertDetail.CanEscalateMonitoring ? "info" : "secondary")"><i class="fas fa-satellite-dish me-1"></i>Escalar monitoreo @(selectedAlertDetail.CanEscalateMonitoring ? "habilitado" : "no disponible")</span>
                                </div>
                            </div>

                            if (selectedAlertDetail.LatestAccess is not null)
                            {
                                var access = selectedAlertDetail.LatestAccess;
                                <div class="mt-4">
                                    <h6>Último intento registrado</h6>
                                    <div class="border rounded p-3 small bg-light">
                                        <div class="d-flex justify-content-between">
                                            <span><i class="fas fa-clock me-1"></i>@access.AccessedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</span>
                                            <span class="badge text-bg-@(access.WasAuthorized ? "success" : "danger")">@(access.WasAuthorized ? "Autorizado" : "Bloqueado")</span>
                                        </div>
                                        <div class="mt-2">Origen: <strong>@(string.IsNullOrWhiteSpace(access.AccessedByUserName) ? "-" : access.AccessedByUserName)</strong></div>
                                        <div>IP / Ubicación: <strong>@access.AccessedByIp</strong> @(string.IsNullOrWhiteSpace(access.Location) ? string.Empty : $"· {access.Location}")</div>
                                        <div class="text-muted">Dispositivo: @(string.IsNullOrWhiteSpace(access.DeviceType) ? "Desconocido" : access.DeviceType) @(string.IsNullOrWhiteSpace(access.OperatingSystem) ? string.Empty : $"· {access.OperatingSystem}")</div>
                                    </div>
                                </div>
                            }

                            <div class="mt-4">
                                <h6>Registro de acciones</h6>
                                @if (selectedAlertDetail.Actions?.Any() == true)
                                {
                                    <ul class="timeline list-unstyled mb-0">
                                        @foreach (var action in selectedAlertDetail.Actions.OrderByDescending(a => a.CreatedAt))
                                        {
                                            <li class="mb-3">
                                                <div class="fw-semibold">@action.ActionType <span class="text-muted">(@action.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm"))</span></div>
                                                <div class="small text-muted">Por: @(string.IsNullOrWhiteSpace(action.CreatedByUserName) ? "IA" : action.CreatedByUserName)</div>
                                                @if (!string.IsNullOrWhiteSpace(action.Notes))
                                                {
                                                    <div class="small">@action.Notes</div>
                                                }
                                                @if (!string.IsNullOrWhiteSpace(action.StatusAfterAction))
                                                {
                                                    <span class="badge bg-light text-dark mt-1">Estado: @action.StatusAfterAction</span>
                                                }
                                            </li>
                                        }
                                    </ul>
                                }
                                else
                                {
                                    <p class="text-muted mb-0">Aún no se registraron acciones sobre esta alerta.</p>
                                }
                            </div>
                        }
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseAlertDetail">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop show"></div>
}

@code {
    private AISecurityDashboardDto? dashboard;
    private AlertSummaryDto? alertSummary;
    private bool isLoading = true;

    private AIScoringSettingsDto aiSettings = new();
    private bool aiSettingsLoading = true;

    private bool scanRunning;
    private string? scanMessage;
    private bool scanSuccess;
    private AIScanSummaryDto? lastScan;

    private string activeTab = "overview";
    private bool showAlertDetail;
    private SecurityAlertDto? selectedAlert;
    private SecurityAlertDetailDto? selectedAlertDetail;
    private string? alertDetailError;
    private bool alertDetailLoading;
    private bool aiSaving;
    private string? aiMessage;
    private bool aiSuccess;

    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(LoadDashboard(), LoadAIScoringSettings(), LoadAlertSummary());
    }

    private async Task LoadDashboard()
    {
        isLoading = true;
        try
        {
            dashboard = await Http.GetFromJsonAsync<AISecurityDashboardDto>("api/aisecurity/dashboard");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading AI dashboard: {ex.Message}");
            dashboard = null;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadAIScoringSettings()
    {
        aiSettingsLoading = true;
        try
        {
            aiSettings = await SettingsService.GetAIScoringSettingsAsync() ?? new AIScoringSettingsDto();
        }
        finally
        {
            aiSettingsLoading = false;
        }
    }

    private async Task LoadAlertSummary()
    {
        try
        {
            alertSummary = await Http.GetFromJsonAsync<AlertSummaryDto>("api/aisecurity/alerts/summary");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading alert summary: {ex.Message}");
            alertSummary = null;
        }
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
        if (showAlertDetail && !string.Equals(tab, "alerts", StringComparison.OrdinalIgnoreCase))
        {
            CloseAlertDetail();
        }
    }

    private async Task RunFullScan()
    {
        scanRunning = true;
        scanMessage = null;
        try
        {
            var response = await Http.PostAsJsonAsync("api/aisecurity/scan-all", (object?)null);
            if (response.IsSuccessStatusCode)
            {
                lastScan = await response.Content.ReadFromJsonAsync<AIScanSummaryDto>();
                scanSuccess = true;
                scanMessage = lastScan?.Message ?? "Escaneo completado";
                await LoadDashboard();
            }
            else
            {
                scanSuccess = false;
                scanMessage = "No se pudo ejecutar el escaneo.";
            }
        }
        catch (Exception ex)
        {
            scanSuccess = false;
            scanMessage = $"Error al ejecutar el escaneo: {ex.Message}";
        }
        finally
        {
            scanRunning = false;
        }
    }

    private async Task SaveAIScoringAsync()
    {
        aiMessage = null;
        aiSaving = true;
        try
        {
            var updated = await SettingsService.UpdateAIScoringSettingsAsync(aiSettings);
            aiSuccess = updated;
            aiMessage = updated
                ? "Configuración de IA actualizada."
                : "No fue posible guardar los parámetros de IA.";
            if (updated)
            {
                var refreshed = await SettingsService.GetAIScoringSettingsAsync();
                if (refreshed is not null)
                {
                    aiSettings = refreshed;
                }
            }
        }
        finally
        {
            aiSaving = false;
        }
    }

    private string GetThreatLevelColor(double level)
    {
        if (level >= 0.7) return "danger";
        if (level >= 0.4) return "warning";
        return "success";
    }

    private string GetThreatLevelText(double level)
    {
        if (level >= 0.7) return "CRÍTICO";
        if (level >= 0.4) return "MEDIO";
        return "BAJO";
    }

    private string GetSeverityColor(string severity) => severity switch
    {
        "Critical" => "danger",
        "High" => "warning",
        "Medium" => "info",
        "Low" => "secondary",
        _ => "secondary"
    };

    private double GetSeverityPercentage(int value, int total)
        => total == 0 ? 0 : (value / (double)total) * 100;

    private async Task OpenAlertDetailAsync(SecurityAlertDto alert)
    {
        selectedAlert = alert;
        selectedAlertDetail = null;
        alertDetailError = null;
        alertDetailLoading = true;
        showAlertDetail = true;

        await InvokeAsync(StateHasChanged);

        try
        {
            var detail = await Http.GetFromJsonAsync<SecurityAlertDetailDto>($"api/aisecurity/alerts/{alert.Id}");
            selectedAlertDetail = detail;
        }
        catch (Exception ex)
        {
            alertDetailError = string.IsNullOrWhiteSpace(ex.Message)
                ? "No se pudo cargar el detalle de la alerta."
                : ex.Message;
        }
        finally
        {
            alertDetailLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void CloseAlertDetail()
    {
        showAlertDetail = false;
        selectedAlert = null;
        selectedAlertDetail = null;
        alertDetailError = null;
        alertDetailLoading = false;
    }

    private static string FormatConfidence(double score)
    {
        var normalized = Math.Clamp(score, 0.0, 1.0);
        return $"{normalized * 100:F0}%";
    }

    private static string FormatAlertDate(DateTime detectedAt)
        => detectedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm");

    private static string FormatAlertStatus(SecurityAlertDto alert)
    {
        if (!string.IsNullOrWhiteSpace(alert.Status))
        {
            return alert.Status;
        }

        return alert.IsReviewed ? "Revisada" : "Pendiente";
    }

    private static string GetEscalationLabel(int level) => level switch
    {
        <= 0 => "Sin escalamiento",
        1 => "Monitoreo",
        2 => "Escalada a analista",
        _ => "Respuesta automática"
    };

    private static string GetSeverityInitial(string? severity)
    {
        if (string.IsNullOrWhiteSpace(severity))
        {
            return "?";
        }

        return char.ToUpperInvariant(severity[0]).ToString();
    }

    private double GetPercentage(int value, int max)
        => max == 0 ? 0 : (value / (double)max) * 100;

    private sealed class InputNumberField : InputNumber<double>
    {
        [Parameter]
        public string Label { get; set; } = string.Empty;

        protected override void BuildRenderTree(RenderTreeBuilder builder)
        {
            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", "mb-3");

            if (!string.IsNullOrWhiteSpace(Label))
            {
                builder.OpenElement(2, "label");
                builder.AddAttribute(3, "class", "form-label");
                builder.AddContent(4, Label);
                builder.CloseElement();
            }

            builder.OpenElement(5, "input");
            builder.AddMultipleAttributes(6, AdditionalAttributes);
            var cssClass = string.IsNullOrWhiteSpace(CssClass)
                ? "form-control"
                : $"form-control {CssClass}".Trim();
            builder.AddAttribute(7, "class", cssClass);
            builder.AddAttribute(8, "type", "number");
            builder.AddAttribute(9, "step", "any");
            builder.AddAttribute(10, "value", BindConverter.FormatValue(CurrentValueAsString));
            builder.AddAttribute(11, "onchange", EventCallback.Factory.CreateBinder<string?>(this, __value => CurrentValueAsString = __value, CurrentValueAsString));
            builder.CloseElement();

            builder.CloseElement();
        }

        protected override bool TryParseValueFromString(string? value, out double result, out string? validationErrorMessage)
        {
            if (BindConverter.TryConvertTo<double>(value, CultureInfo.InvariantCulture, out result))
            {
                validationErrorMessage = null;
                return true;
            }

            validationErrorMessage = "El valor debe ser numérico";
            return false;
        }

        protected override string FormatValueAsString(double value)
            => BindConverter.FormatValue(value, CultureInfo.InvariantCulture);

    }
}
