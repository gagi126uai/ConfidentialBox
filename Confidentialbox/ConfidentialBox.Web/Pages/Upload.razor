@page "/upload"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using System.IO;
@using System.Linq;
@attribute [Authorize]
@inject IFileService FileService
@inject IJSRuntime JS
@inject NavigationManager NavigationManager
@using System.Security.Cryptography

<PageTitle>Subir Archivo - ConfidentialBox</PageTitle>

<h1><i class="fas fa-cloud-upload-alt"></i> Subir Archivo</h1>

<div class="row mt-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">

                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle"></i> @successMessage
                        <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
                    </div>

                    @if (!string.IsNullOrEmpty(shareLink))
                    {
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h6>Link para compartir:</h6>
                                <div class="input-group">
                                    <input type="text" class="form-control" value="@GetFullShareLink()" readonly />
                                    <button class="btn btn-outline-secondary" @onclick="CopyToClipboard">
                                        <i class="fas fa-copy"></i> Copiar
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                }

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-circle"></i> @errorMessage
                        <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
                    </div>
                }

                <!-- Drag and Drop Area -->
                <label class="drop-zone @(isDragging ? "dragging" : "")"
                       @ondragenter="HandleDragEnter"
                       @ondragenter:preventDefault
                       @ondragleave="HandleDragLeave"
                       @ondragover:preventDefault
                       @ondrop="HandleDrop"
                       @ondrop:preventDefault>

                    <InputFile id="secureUploadInput" OnChange="HandleFileSelected" class="drop-zone-input" />

                    <div class="drop-zone-content text-center py-5">
                        <i class="fas fa-cloud-upload-alt fa-5x text-muted mb-3"></i>
                        <h4>Arrastra y suelta tu archivo aquí</h4>
                        <p class="text-muted">o</p>
                        <span class="btn btn-primary">
                            <i class="fas fa-folder-open"></i> Seleccionar archivo
                        </span>
                    </div>
                </label>

                @if (selectedFile != null)
                {
                    <div class="mt-4">
                        <h5>Archivo Seleccionado:</h5>

                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-file fa-2x me-3 text-primary"></i>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">@selectedFile.Name</h6>
                                        <small class="text-muted">@FormatBytes(selectedFile.Size)</small>
                                    </div>
                                    <button class="btn btn-sm btn-danger" @onclick="ClearFile">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Opciones de configuración -->
                        <div class="mt-4">
                            <h5>Opciones de Seguridad:</h5>

                            <div class="mb-3">
                                <label class="form-label">Contraseña Maestra (Opcional)</label>
                                <input type="password"
                                       class="form-control"
                                       @bind="masterPassword"
                                       placeholder="Dejar vacío para no usar contraseña" />
                                <small class="text-muted">Si se establece, se requerirá esta contraseña para acceder al archivo</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Fecha de Expiración (Opcional)</label>
                                <input type="datetime-local"
                                       class="form-control"
                                       @bind="expirationDate" />
                                <small class="text-muted">Dejar vacío para que no expire</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Límite de Accesos (Opcional)</label>
                                <input type="number"
                                       class="form-control"
                                       @bind="maxAccesses"
                                       min="1"
                                       placeholder="Dejar vacío para accesos ilimitados" />
                                <small class="text-muted">Número máximo de veces que se puede acceder al archivo</small>
                            </div>

                            @if (selectedFile != null && IsPDF(selectedFile.Name))
                            {
                                <div class="card bg-info text-white mb-3">
                                    <div class="card-body">
                                        <h6><i class="fas fa-shield-alt"></i> Protección Especial para PDF</h6>
                                        <p class="small mb-3">Este archivo será protegido con nuestro visualizador seguro</p>

                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" @bind="enableWatermark" id="watermarkCheck" />
                                            <label class="form-check-label" for="watermarkCheck">
                                                <strong>Marca de agua "CONFIDENTIAL"</strong>
                                            </label>
                                        </div>

                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" @bind="screenshotProtection" id="screenshotCheck" />
                                            <label class="form-check-label" for="screenshotCheck">
                                                <strong>Bloquear capturas de pantalla</strong>
                                            </label>
                                        </div>

                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" @bind="aiMonitoring" id="aiCheck" />
                                            <label class="form-check-label" for="aiCheck">
                                                <strong>Monitoreo con IA</strong> - Detecta comportamientos sospechosos
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            }

                            <button class="btn btn-success btn-lg w-100"
                                    @onclick="UploadFile"
                                    disabled="@isUploading">
                                @if (isUploading)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    @:Cifrando y Subiendo...
                                }
                                else
                                {
                                    <i class="fas fa-lock"></i>
                                    @:Cifrar y Subir Archivo
                                }
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h5><i class="fas fa-shield-alt"></i> Seguridad</h5>
                <p class="small">
                    Tu archivo será cifrado en el navegador antes de ser enviado al servidor.
                    Nadie, ni siquiera los administradores, podrán ver el contenido sin la clave de cifrado.
                </p>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-body">
                <h6><i class="fas fa-info-circle"></i> Características:</h6>
                <ul class="small">
                    <li>Cifrado AES-256 en el navegador</li>
                    <li>Links seguros de un solo uso</li>
                    <li>Control de accesos y expiración</li>
                    <li>Auditoría completa de accesos</li>
                    <li>Protección con contraseña opcional</li>
                </ul>
            </div>
        </div>
    </div>
</div>

@code {
    private const long MaxUpload = 100 * 1024 * 1024; // 100 MB

    private IBrowserFile? selectedFile;
    private string? masterPassword;
    private DateTime? expirationDate;
    private int? maxAccesses;

    private bool isUploading = false;
    private bool isDragging = false;

    private string? errorMessage;
    private string? successMessage;
    private string? shareLink;

    // Configuración PDF
    private bool enableWatermark = true;
    private bool screenshotProtection = true;
    private bool aiMonitoring = true;

    // Para construir el link correcto luego de la subida
    private bool lastUploadedWasPdf = false;

    private bool _isDragging;

        if (e.DataTransfer is null)
        {
            return;
        }

        IBrowserFile? browserFile = null;

        if (e.DataTransfer.Files?.Count > 0)
        {
            browserFile = e.DataTransfer.Files[0];
        }
        else if (e.DataTransfer.Items?.Count > 0)
        {
            foreach (var item in e.DataTransfer.Items)
            {
                if (string.Equals(item.Kind, "file", StringComparison.OrdinalIgnoreCase))
                {
                    browserFile = await item.GetFileAsync();
                    if (browserFile != null)
                    {
                        break;
                    }
                }
            }
        }

        if (browserFile != null)
        {
            await SelectFileAsync(browserFile);
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        if (e.FileCount > 0)
            await SelectFileAsync(e.File);
    }

    private Task SelectFileAsync(IBrowserFile file)
    {
        selectedFile = file;
        errorMessage = null;
        successMessage = null;
        shareLink = null;

        return InvokeAsync(StateHasChanged);
    }

    private void ClearFile()
    {
        selectedFile = null;
        masterPassword = null;
        expirationDate = null;
        maxAccesses = null;
        errorMessage = null;
        successMessage = null;
        shareLink = null;

        enableWatermark = true;
        screenshotProtection = true;
        aiMonitoring = true;
        // No afectar lastUploadedWasPdf (depende del último upload exitoso)
    }

    private bool IsPDF(string filename)
        => filename.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase);

    private async Task UploadFile()
    {
        if (selectedFile == null) return;

        isUploading = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            if (selectedFile.Size > MaxUpload)
            {
                errorMessage = "El archivo supera el límite de 100 MB.";
                return;
            }

            // Flag local, para no “pegar” un estado si falla la subida
            var isPdf = IsPDF(selectedFile.Name);

            // Leer por stream (sin reservar byte[] con long)
            using var readStream = selectedFile.OpenReadStream(maxAllowedSize: MaxUpload);
            using var ms = new MemoryStream();
            await readStream.CopyToAsync(ms);
            var buffer = ms.ToArray();

            var (encryptionKey, encryptedContent) = EncryptBuffer(buffer);

            var request = new FileUploadRequest
            {
                OriginalFileName = selectedFile.Name,
                EncryptedFileName = $"{Guid.NewGuid()}{Path.GetExtension(selectedFile.Name)}",
                FileExtension = Path.GetExtension(selectedFile.Name),
                FileSizeBytes = selectedFile.Size,
                EncryptionKey = encryptionKey,
                EncryptedContent = encryptedContent,
                MasterPassword = string.IsNullOrWhiteSpace(masterPassword) ? null : masterPassword,
                ExpiresAt = expirationDate?.ToUniversalTime(),
                MaxAccessCount = maxAccesses,
                EnableWatermark = isPdf && enableWatermark,
                WatermarkText = isPdf && enableWatermark ? "CONFIDENTIAL" : null,
                ScreenshotProtection = isPdf && screenshotProtection,
                PrintProtection = isPdf && screenshotProtection,
                CopyProtection = isPdf && screenshotProtection,
                AiMonitoring = isPdf && aiMonitoring,
                MaxViewTimeMinutes = 0
            };

            var result = await FileService.UploadFileAsync(request);

            if (result.Success)
            {
                shareLink = result.ShareLink;
                successMessage = "¡Archivo subido exitosamente!";
                selectedFile = null;
                lastUploadedWasPdf = isPdf; // setear sólo si la subida fue exitosa
            }
            else
            {
                errorMessage = result.ErrorMessage ?? "Error al subir el archivo";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isUploading = false;
        }
    }

    private (string encryptionKey, string encryptedPayload) EncryptBuffer(byte[] buffer)
    {
        using var aes = Aes.Create();
        aes.KeySize = 256;
        aes.GenerateKey();
        aes.GenerateIV();

        using var encryptor = aes.CreateEncryptor(aes.Key, aes.IV);
        using var ms = new MemoryStream();
        using (var cryptoStream = new CryptoStream(ms, encryptor, CryptoStreamMode.Write))
        {
            cryptoStream.Write(buffer, 0, buffer.Length);
            cryptoStream.FlushFinalBlock();
        }

        var cipherBytes = ms.ToArray();
        var payload = new byte[aes.IV.Length + cipherBytes.Length];
        Buffer.BlockCopy(aes.IV, 0, payload, 0, aes.IV.Length);
        Buffer.BlockCopy(cipherBytes, 0, payload, aes.IV.Length, cipherBytes.Length);

        return (Convert.ToBase64String(aes.Key), Convert.ToBase64String(payload));
    }

    private string GetFullShareLink()
    {
        if (string.IsNullOrEmpty(shareLink))
            return string.Empty;

        var baseUri = NavigationManager.BaseUri.TrimEnd('/');

        return lastUploadedWasPdf
            ? $"{baseUri}/view-pdf/{shareLink}"
            : $"{baseUri}/access/{shareLink}";
    }

    private async Task CopyToClipboard()
    {
        var link = GetFullShareLink();
        if (!string.IsNullOrEmpty(link))
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", link);
        }
    }

    private string FormatBytes(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;

        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len /= 1024;
        }

        return $"{len:0.##} {sizes[order]}";
    }
}
