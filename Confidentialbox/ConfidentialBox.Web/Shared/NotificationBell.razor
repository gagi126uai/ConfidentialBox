@inject INotificationService NotificationService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager
@using System
@using System.Linq

<div class="notification-bell" @onclick:stopPropagation="true">
    <button class="notification-trigger" @onclick="ToggleDropdown" title="Notificaciones">
        <span class="notification-icon">
            <i class="fas fa-bell"></i>
            @if (unreadCount > 0)
            {
                <span class="notification-count">@unreadCount</span>
            }
        </span>
        <span class="notification-label">Alertas</span>
    </button>

    @if (showDropdown)
    {
        <div class="notification-panel shadow-lg">
            <div class="notification-panel__header">
                <div>
                    <h6 class="mb-0">Centro de notificaciones</h6>
                    <small class="text-muted">Monitoreo en vivo de tu actividad sensible</small>
                </div>
                <button class="btn btn-sm btn-outline-primary" @onclick="RefreshAsync">
                    <i class="fas fa-rotate"></i>
                </button>
            </div>

            @if (!string.IsNullOrEmpty(loadError))
            {
                <div class="alert alert-warning py-2 px-3 small mb-3" role="alert">
                    <i class="fas fa-circle-exclamation me-1"></i>@loadError
                </div>
            }

            @if (isLoading)
            {
                <div class="notification-panel__loading">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <span>Cargando notificaciones…</span>
                </div>
            }
            else if (notifications.Count == 0)
            {
                <div class="notification-panel__empty">
                    <i class="fas fa-magic"></i>
                    <p class="mb-0">¡Todo en orden! No tienes alertas pendientes.</p>
                </div>
            }
            else
            {
                <div class="notification-panel__content" role="list">
                    <ul class="notification-list">
                        @foreach (var notification in notifications)
                        {
                            <li class="notification-card @GetSeverityClass(notification) @(notification.IsRead ? string.Empty : "unread")" role="listitem" @onclick="() => OnNotificationClicked(notification)">
                                <div class="notification-card__icon">
                                    <i class="fas fa-shield-alt"></i>
                                </div>
                                <div class="notification-card__body">
                                    <div class="notification-card__title">@notification.Title</div>
                                    <div class="notification-card__message">@notification.Message</div>
                                    <div class="notification-card__meta">
                                        <i class="fas fa-clock me-1"></i>@notification.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                                        <span class="notification-card__dot" aria-hidden="true"></span>
                                        <span class="notification-card__relative">@GetRelativeTime(notification.CreatedAt)</span>
                                    </div>
                                </div>
                                <div class="notification-card__actions">
                                    @if (!string.IsNullOrWhiteSpace(notification.Link))
                                    {
                                        <button type="button" class="notification-card__action" @onclick="(args) => OnNotificationClicked(notification)" @onclick:stopPropagation="true" title="Ver detalle">
                                            <i class="fas fa-arrow-up-right-from-square"></i>
                                        </button>
                                    }
                                    <button type="button" class="notification-card__dismiss" @onclick="(args) => DeleteNotificationAsync(notification)" @onclick:stopPropagation="true" title="Eliminar notificación" aria-label="Eliminar notificación">
                                        <i class="fas fa-xmark"></i>
                                    </button>
                                </div>
                            </li>
                        }
                    </ul>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<UserNotificationDto> notifications = new();
    private int unreadCount;
    private bool showDropdown;
    private bool isLoading;
    private bool initialized;
    private string? loadError;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated == true)
        {
            await LoadAsync();
            initialized = true;
        }
    }

    private async Task LoadAsync()
    {
        try
        {
            isLoading = true;
            loadError = null;
            unreadCount = await NotificationService.GetUnreadCountAsync();
            notifications = await NotificationService.GetNotificationsAsync();
        }
        catch (Exception ex)
        {
            notifications = new List<UserNotificationDto>();
            loadError = string.IsNullOrWhiteSpace(ex.Message)
                ? "No se pudieron obtener las notificaciones."
                : ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RefreshAsync()
    {
        await LoadAsync();
    }

    private async Task ToggleDropdown()
    {
        if (!initialized)
        {
            await LoadAsync();
            initialized = true;
        }

        showDropdown = !showDropdown;

        if (showDropdown)
        {
            var unreadIds = notifications.Where(n => !n.IsRead).Select(n => n.Id).ToList();
            if (unreadIds.Count > 0)
            {
                try
                {
                    await NotificationService.MarkAsReadAsync(unreadIds);
                    unreadCount = 0;
                    foreach (var notification in notifications)
                    {
                        notification.IsRead = true;
                    }
                    loadError = null;
                }
                catch (Exception ex)
                {
                    loadError = string.IsNullOrWhiteSpace(ex.Message)
                        ? "No se pudieron marcar las notificaciones como leídas."
                        : ex.Message;
                }
            }
        }
    }

    private void OnNotificationClicked(UserNotificationDto notification)
    {
        if (string.IsNullOrWhiteSpace(notification.Link))
        {
            return;
        }

        showDropdown = false;
        NavigationManager.NavigateTo(notification.Link);
    }

    private async Task DeleteNotificationAsync(UserNotificationDto notification)
    {
        try
        {
            await NotificationService.DeleteAsync(notification.Id);
            notifications.Remove(notification);

            if (!notification.IsRead && unreadCount > 0)
            {
                unreadCount = Math.Max(0, unreadCount - 1);
            }

            loadError = null;
        }
        catch (Exception ex)
        {
            loadError = string.IsNullOrWhiteSpace(ex.Message)
                ? "No se pudo eliminar la notificación."
                : ex.Message;
        }
    }

    private static string GetRelativeTime(DateTime timestamp)
    {
        var delta = DateTime.UtcNow - timestamp.ToUniversalTime();

        if (delta.TotalSeconds < 60)
        {
            return "Justo ahora";
        }

        if (delta.TotalMinutes < 60)
        {
            return $"{Math.Floor(delta.TotalMinutes)} min atras";
        }

        if (delta.TotalHours < 24)
        {
            return $"{Math.Floor(delta.TotalHours)} h atras";
        }

        if (delta.TotalDays < 7)
        {
            return $"{Math.Floor(delta.TotalDays)} d atras";
        }

        return timestamp.ToLocalTime().ToString("dd/MM/yyyy");
    }

    private static string GetSeverityClass(UserNotificationDto notification)
    {
        return notification.Severity switch
        {
            "danger" => "notification-danger",
            "warning" => "notification-warning",
            "success" => "notification-success",
            _ => "notification-info"
        };
    }
}
